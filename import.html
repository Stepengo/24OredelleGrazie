<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pallascout</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db">
    <meta name="description" content="App per gestire tornei di pallascout con arbitri, squadre e statistiche">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pallascout">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px; /* Spazio per install banner */
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            padding: 15px;
            text-align: center;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .install-banner.show {
            transform: translateY(0);
        }

        .install-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: white;
            color: #3498db;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .player-list {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .match-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .teams-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .team-info {
            text-align: center;
            flex: 1;
        }

        .vs {
            margin: 0 20px;
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .stats-input {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stats-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #3498db;
            color: white;
        }

        .table tr:hover {
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .player-stats {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                font-size: 14px;
                padding: 8px 16px;
            }
            
            .match-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-input {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PWA Install Banner -->
        <div id="installBanner" class="install-banner">
            <div>
                üì± <strong>Installa l'App Pallascout!</strong><br>
                <small>Accesso rapido e funzionalit√† offline</small><br>
                <button id="installBtn" class="install-btn">‚¨áÔ∏è Installa</button>
                <button id="dismissBtn" class="install-btn">‚ùå Chiudi</button>
            </div>
        </div>

        <!-- Offline Indicator -->
        <div id="offlineIndicator" class="offline-indicator">
            üì° Modalit√† Offline
        </div>

        <div class="header">
            <h1>üèÜ Torneo Pallascout</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('teams')">Squadre</button>
                <button class="nav-tab" onclick="showTab('matches')">Partite</button>
                <button class="nav-tab" onclick="showTab('referee')">Arbitro</button>
                <button class="nav-tab" onclick="showTab('standings')">Classifica</button>
                <button class="nav-tab" onclick="showTab('stats')">Statistiche</button>
                <button class="nav-tab" onclick="showTab('admin')">Admin</button>
            </div>
        </div>

        <!-- Tab Squadre -->
        <div id="teams" class="tab-content active">
            <h2>Gestione Squadre</h2>
            
            <div class="card">
                <h3>üìä Importa da Google Sheets</h3>
                <p>Importa squadre e giocatori copiando i dati dal tuo foglio:</p>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>üìù Come fare:</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Apri il tuo <strong>Google Sheets</strong></li>
                        <li>Seleziona le celle con: <code>Squadra | Nome Giocatore | Numero</code></li>
                        <li>Copia tutto (<kbd>Ctrl+C</kbd> o <kbd>Cmd+C</kbd>)</li>
                        <li>Incolla nel campo qui sotto</li>
                        <li>Clicca "Importa"</li>
                    </ol>
                </div>
                
                <div class="form-group">
                    <label>üìã Incolla qui i dati da Google Sheets:</label>
                    <textarea id="importTeamsData" 
                              style="width: 100%; height: 250px; font-family: monospace; font-size: 13px;" 
                              placeholder="Esempio formato:
Squadra A    Mario Rossi      10
Squadra A    Luigi Verdi      7
Squadra A    Paolo Bianchi    5
Squadra B    Andrea Neri      9
Squadra B    Marco Blu        11

Oppure separato da virgole:
Squadra A, Mario Rossi, 10
Squadra A, Luigi Verdi, 7"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="importTeamsFromText()">
                        üìä Importa Dati
                    </button>
                    <button class="btn btn-info" onclick="showImportExample()">
                        ‚ùì Vedi Esempio
                    </button>
                    <button class="btn btn-warning" onclick="downloadTemplate()">
                        üì• Scarica Template
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3>‚ûï Aggiungi Manualmente</h3>
                <div class="form-group">
                    <label>Nome Squadra:</label>
                    <input type="text" id="teamName" placeholder="Inserisci nome squadra">
                </div>
                <button class="btn btn-primary" onclick="addTeam()">Aggiungi Squadra</button>
            </div>
            
            <div id="teamsList"></div>
        </div>

        <!-- Tab Partite -->
        <div id="matches" class="tab-content">
            <h2>Gestione Partite</h2>
            <div class="form-group">
                <label>Squadra Casa:</label>
                <select id="homeTeam"></select>
            </div>
            <div class="form-group">
                <label>Squadra Ospite:</label>
                <select id="awayTeam"></select>
            </div>
            <div class="form-group">
                <label>Campo:</label>
                <input type="text" id="matchField" placeholder="Campo 1">
            </div>
            <button class="btn btn-primary" onclick="createMatch()">Crea Partita</button>
            
            <div id="matchesList"></div>
        </div>

        <!-- Tab Arbitro -->
        <div id="referee" class="tab-content">
            <h2>Pannello Arbitro</h2>
            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn btn-info" onclick="setArbitratorName()">üë§ Imposta Nome Arbitro</button>
                <span id="arbitratorDisplay" style="margin-left: 15px; font-weight: bold;"></span>
            </div>
            <div class="form-group">
                <label>Seleziona Partita da Arbitrare:</label>
                <select id="refereeMatchSelect" onchange="loadRefereeMatch()"></select>
            </div>
            <div id="refereePanel"></div>
        </div>

        <!-- Tab Classifica -->
        <div id="standings" class="tab-content">
            <h2>Classifica Generale</h2>
            <div id="standingsTable"></div>
        </div>

        <!-- Tab Statistiche -->
        <div id="stats" class="tab-content">
            <h2>Statistiche</h2>
            <div id="statsContent"></div>
        </div>

        <!-- Tab Admin -->
        <div id="admin" class="tab-content">
            <h2>üèÜ Pannello Organizzatore</h2>
            
            <div class="card">
                <h3>üì• Importa Report Arbitri</h3>
                <p>Importa i report ricevuti dagli arbitri per aggiornare il database centrale:</p>
                
                <div style="margin: 20px 0;">
                    <h4>üìã Importa Report Singolo</h4>
                    <textarea id="singleReportInput" 
                              style="width: 100%; height: 300px; margin: 10px 0;" 
                              placeholder="Incolla qui il report ricevuto dall'arbitro via WhatsApp...

üèÜ REPORT PARTITA PALLASCOUT üèÜ
üìÖ Data: 28/9/2025, 15:30:00
üèüÔ∏è Campo: Campo 1
üìä Risultato: Squadra A 3 - 1 Squadra B
..."></textarea>
                    <button class="btn btn-success" onclick="processSingleReport()">
                        üìä Elabora Report
                    </button>
                </div>

                <div style="margin: 20px 0;">
                    <h4>üìö Importa Report Multipli</h4>
                    <textarea id="bulkReportsInput" 
                              style="width: 100%; height: 200px; margin: 10px 0;" 
                              placeholder="Incolla qui tutti i report degli arbitri, uno dopo l'altro..."></textarea>
                    <button class="btn btn-success" onclick="processBulkReports()">
                        üìä Elabora Tutti i Report
                    </button>
                </div>

                <div style="margin: 20px 0;">
                    <h4>üìÅ Importa File JSON</h4>
                    <input type="file" id="jsonImportInput" accept=".json" 
                           onchange="importCompleteData(event)">
                    <p style="font-size: 12px; color: #666;">Importa database completo da un altro organizzatore</p>
                </div>
            </div>

            <div class="card">
                <h3>üìä Stato Partite</h3>
                <div id="matchStatusSummary"></div>
                <button class="btn btn-info" onclick="showDetailedMatchStatus()">
                    üìã Dettagli Partite
                </button>
            </div>

            <div class="card">
                <h3>üíæ Esporta Dati Completi</h3>
                <p>Esporta tutti i dati del torneo in diversi formati:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button class="btn btn-primary" onclick="exportCompleteJSON()">
                        üìÑ Esporta JSON Completo
                    </button>
                    <button class="btn btn-success" onclick="exportExcelFormat()">
                        üìä Esporta per Excel
                    </button>
                    <button class="btn btn-warning" onclick="exportPrintableReport()">
                        üñ®Ô∏è Report Stampabile
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>üîß Strumenti Admin</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button class="btn btn-warning" onclick="validateData()">
                        ‚úÖ Valida Dati
                    </button>
                    <button class="btn btn-success" onclick="backupData()">
                        üíæ Backup Completo
                    </button>
                    <button class="btn btn-danger" onclick="resetTournament()">
                        üóëÔ∏è Reset Torneo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per aggiungere giocatori -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePlayerModal()">&times;</span>
            <h3 id="modalTitle">Aggiungi Giocatore</h3>
            <div class="form-group">
                <label>Nome Giocatore:</label>
                <input type="text" id="playerName">
            </div>
            <div class="form-group">
                <label>Numero Maglia:</label>
                <input type="number" id="playerNumber" min="1">
            </div>
            <button class="btn btn-primary" onclick="addPlayer()">Aggiungi</button>
        </div>
    </div>

    <script>
        // Strutture dati
        let teams = JSON.parse(localStorage.getItem('pallascout_teams') || '[]');
        let matches = JSON.parse(localStorage.getItem('pallascout_matches') || '[]');
        let currentTeamId = null;

        // Funzioni di salvataggio
        function saveData() {
            localStorage.setItem('pallascout_teams', JSON.stringify(teams));
            localStorage.setItem('pallascout_matches', JSON.stringify(matches));
        }

        // Gestione tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'matches') {
                updateTeamSelects();
                displayMatches();
            } else if (tabName === 'referee') {
                updateRefereeMatchSelect();
                updateArbitratorDisplay();
            } else if (tabName === 'standings') {
                displayStandings();
            } else if (tabName === 'stats') {
                displayStats();
            } else if (tabName === 'admin') {
                updateMatchStatusSummary();
            } else if (tabName === 'teams') {
                displayTeams();
            }
        }

        // Gestione squadre
        function addTeam() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Inserisci un nome per la squadra');
                return;
            }

            const team = {
                id: Date.now(),
                name: teamName,
                players: [],
                stats: {
                    matches: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    scalpFor: 0,
                    scalpAgainst: 0
                }
            };

            teams.push(team);
            saveData();
            document.getElementById('teamName').value = '';
            displayTeams();
        }

        function displayTeams() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';

            teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = 'card';
                teamCard.innerHTML = `
                    <h3>${team.name}</h3>
                    <p>Giocatori: ${team.players.length}</p>
                    <div class="player-list" id="players-${team.id}">
                        ${team.players.map(player => `
                            <div class="player-item">
                                <span>#${player.number} - ${player.name}</span>
                                <button class="btn btn-danger" onclick="removePlayer(${team.id}, ${player.id})">Rimuovi</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-success" onclick="openPlayerModal(${team.id})">Aggiungi Giocatore</button>
                    <button class="btn btn-danger" onclick="removeTeam(${team.id})">Elimina Squadra</button>
                `;
                teamsList.appendChild(teamCard);
            });
        }

        function openPlayerModal(teamId) {
            currentTeamId = teamId;
            const team = teams.find(t => t.id === teamId);
            document.getElementById('modalTitle').textContent = `Aggiungi Giocatore - ${team.name}`;
            document.getElementById('playerModal').style.display = 'block';
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('playerName').value = '';
            document.getElementById('playerNumber').value = '';
        }

        function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            const playerNumber = parseInt(document.getElementById('playerNumber').value);
            
            if (!playerName || !playerNumber) {
                alert('Inserisci nome e numero del giocatore');
                return;
            }

            const team = teams.find(t => t.id === currentTeamId);
            if (team.players.some(p => p.number === playerNumber)) {
                alert('Numero maglia gi√† utilizzato');
                return;
            }

            const player = {
                id: Date.now(),
                name: playerName,
                number: playerNumber,
                stats: {
                    goals: 0,
                    scalps: 0,
                    mvp: 0
                }
            };

            team.players.push(player);
            saveData();
            closePlayerModal();
            displayTeams();
        }

        function removePlayer(teamId, playerId) {
            const team = teams.find(t => t.id === teamId);
            team.players = team.players.filter(p => p.id !== playerId);
            saveData();
            displayTeams();
        }

        function removeTeam(teamId) {
            if (confirm('Sei sicuro di voler eliminare questa squadra?')) {
                teams = teams.filter(t => t.id !== teamId);
                saveData();
                displayTeams();
            }
        }

        // Gestione partite
        function updateTeamSelects() {
            const homeSelect = document.getElementById('homeTeam');
            const awaySelect = document.getElementById('awayTeam');
            
            const options = '<option value="">Seleziona squadra</option>' + 
                          teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('');
            
            homeSelect.innerHTML = options;
            awaySelect.innerHTML = options;
        }

        function createMatch() {
            const homeTeamId = parseInt(document.getElementById('homeTeam').value);
            const awayTeamId = parseInt(document.getElementById('awayTeam').value);
            const field = document.getElementById('matchField').value.trim();

            if (!homeTeamId || !awayTeamId || homeTeamId === awayTeamId) {
                alert('Seleziona due squadre diverse');
                return;
            }

            const match = {
                id: Date.now(),
                homeTeamId,
                awayTeamId,
                field: field || 'Campo TBD',
                status: 'scheduled', // scheduled, in_progress, completed
                homeScore: 0,
                awayScore: 0,
                playerStats: {},
                homeMVP: null,
                awayMVP: null,
                startTime: new Date().toISOString()
            };

            matches.push(match);
            saveData();
            displayMatches();
            updateRefereeMatchSelect();
            
            // Reset form
            document.getElementById('homeTeam').value = '';
            document.getElementById('awayTeam').value = '';
            document.getElementById('matchField').value = '';
        }

        function displayMatches() {
            const matchesList = document.getElementById('matchesList');
            matchesList.innerHTML = '<div class="match-grid"></div>';
            const matchGrid = matchesList.querySelector('.match-grid');

            matches.forEach(match => {
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                
                if (!homeTeam || !awayTeam) return;

                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                matchCard.innerHTML = `
                    <div class="match-header">
                        <h4>${match.field}</h4>
                        <span class="badge">${getStatusText(match.status)}</span>
                    </div>
                    <div class="teams-display">
                        <div class="team-info">
                            <h5>${homeTeam.name}</h5>
                            <span class="score">${match.homeScore || 0}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team-info">
                            <h5>${awayTeam.name}</h5>
                            <span class="score">${match.awayScore || 0}</span>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="deleteMatch(${match.id})">Elimina</button>
                `;
                matchGrid.appendChild(matchCard);
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'scheduled': return 'Programmata';
                case 'in_progress': return 'In corso';
                case 'completed': return 'Completata';
                default: return 'Sconosciuto';
            }
        }

        function deleteMatch(matchId) {
            if (confirm('Sei sicuro di voler eliminare questa partita?')) {
                matches = matches.filter(m => m.id !== matchId);
                saveData();
                displayMatches();
                updateRefereeMatchSelect();
            }
        }

        // Gestione arbitro
        function updateRefereeMatchSelect() {
            const select = document.getElementById('refereeMatchSelect');
            if (!select) return;
            
            const availableMatches = matches.filter(m => m.status === 'scheduled' || m.status === 'in_progress');
            
            if (availableMatches.length === 0) {
                select.innerHTML = '<option value="">Nessuna partita disponibile</option>';
                return;
            }
            
            let optionsHTML = '<option value="">Seleziona partita da arbitrare</option>';
            
            availableMatches.forEach(match => {
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                
                if (homeTeam && awayTeam) {
                    const status = match.status === 'in_progress' ? ' (In corso)' : '';
                    optionsHTML += `<option value="${match.id}">${homeTeam.name} vs ${awayTeam.name} - ${match.field}${status}</option>`;
                }
            });
            
            select.innerHTML = optionsHTML;
        }

        function updateArbitratorDisplay() {
            const display = document.getElementById('arbitratorDisplay');
            if (!display) return;
            
            const name = getArbitratorName();
            if (name) {
                display.textContent = `Arbitro: ${name}`;
                display.style.color = '#27ae60';
            } else {
                display.textContent = '(Nome non impostato - clicca per impostarlo)';
                display.style.color = '#e74c3c';
            }
        }

        function loadRefereeMatch() {
            const matchId = parseInt(document.getElementById('refereeMatchSelect').value);
            if (!matchId) {
                document.getElementById('refereePanel').innerHTML = '';
                return;
            }

            const match = matches.find(m => m.id === matchId);
            if (!match) {
                alert('Partita non trovata');
                return;
            }

            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);

            if (!homeTeam || !awayTeam) {
                alert('Errore: squadre della partita non trovate');
                return;
            }

            if (match.status === 'scheduled') {
                match.status = 'in_progress';
                saveData();
            }

            if (!match.playerStats) {
                match.playerStats = {};
            }

            document.getElementById('refereePanel').innerHTML = `
                <div class="card">
                    <h3>${homeTeam.name} vs ${awayTeam.name}</h3>
                    <div class="teams-display">
                        <div class="team-info">
                            <h4 id="homeScore">${homeTeam.name}: ${match.homeScore || 0}</h4>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team-info">
                            <h4 id="awayScore">${awayTeam.name}: ${match.awayScore || 0}</h4>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h4>${homeTeam.name}</h4>
                            <div id="homePlayersStats">
                                ${homeTeam.players.map(player => `
                                    <div class="player-stats">
                                        <strong>#${player.number} ${player.name}</strong>
                                        <div class="stats-input" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                            <input type="number" placeholder="Gol" min="0" 
                                                   value="${match.playerStats[player.id]?.goals || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'goals', this.value)">
                                            <input type="number" placeholder="Scalpi" min="0" 
                                                   value="${match.playerStats[player.id]?.scalps || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'scalps', this.value)">
                                            <label style="display: flex; align-items: center; justify-content: center;">
                                                <input type="radio" name="homeMVP" value="${player.id}" 
                                                       ${match.homeMVP === player.id ? 'checked' : ''}
                                                       onchange="updateMVP(${match.id}, 'home', ${player.id})"> MVP
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4>${awayTeam.name}</h4>
                            <div id="awayPlayersStats">
                                ${awayTeam.players.map(player => `
                                    <div class="player-stats">
                                        <strong>#${player.number} ${player.name}</strong>
                                        <div class="stats-input" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                            <input type="number" placeholder="Gol" min="0" 
                                                   value="${match.playerStats[player.id]?.goals || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'goals', this.value)">
                                            <input type="number" placeholder="Scalpi" min="0" 
                                                   value="${match.playerStats[player.id]?.scalps || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'scalps', this.value)">
                                            <label style="display: flex; align-items: center; justify-content: center;">
                                                <input type="radio" name="awayMVP" value="${player.id}" 
                                                       ${match.awayMVP === player.id ? 'checked' : ''}
                                                       onchange="updateMVP(${match.id}, 'away', ${player.id})"> MVP
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-success" onclick="completeMatch(${match.id})">Termina Partita</button>
                        <button class="btn btn-warning" onclick="saveMatchProgress(${match.id})">Salva Progresso</button>
                    </div>
                </div>
            `;
        }

        function updatePlayerStat(matchId, playerId, stat, value) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            if (!match.playerStats) {
                match.playerStats = {};
            }
            
            if (!match.playerStats[playerId]) {
                match.playerStats[playerId] = { goals: 0, scalps: 0 };
            }
            
            match.playerStats[playerId][stat] = parseInt(value) || 0;
            
            calculateMatchScore(match);
            saveData();
            updateScoreDisplay(match);
        }

        function updateScoreDisplay(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            const homeScoreElement = document.getElementById('homeScore');
            const awayScoreElement = document.getElementById('awayScore');
            
            if (homeScoreElement) {
                homeScoreElement.textContent = `${homeTeam.name}: ${match.homeScore || 0}`;
            }
            if (awayScoreElement) {
                awayScoreElement.textContent = `${awayTeam.name}: ${match.awayScore || 0}`;
            }
        }

        function updateMVP(matchId, team, playerId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            if (team === 'home') {
                match.homeMVP = parseInt(playerId);
            } else {
                match.awayMVP = parseInt(playerId);
            }
            saveData();
        }

        function calculateMatchScore(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            if (!homeTeam || !awayTeam) return;
            
            let homeScore = 0;
            let awayScore = 0;

            homeTeam.players.forEach(player => {
                if (match.playerStats && match.playerStats[player.id]) {
                    homeScore += match.playerStats[player.id].goals || 0;
                }
            });

            awayTeam.players.forEach(player => {
                if (match.playerStats && match.playerStats[player.id]) {
                    awayScore += match.playerStats[player.id].goals || 0;
                }
            });

            match.homeScore = homeScore;
            match.awayScore = awayScore;
        }

        function saveMatchProgress(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            saveData();
            alert('‚úÖ Progresso della partita salvato!');
        }

        function completeMatch(matchId) {
            if (!confirm('Sei sicuro di voler terminare questa partita?')) return;
            
            const match = matches.find(m => m.id === matchId);
            if (!match) {
                alert('Errore: partita non trovata');
                return;
            }
            
            match.status = 'completed';
            match.completedAt = new Date().toISOString();
            
            updateTeamStats(match);
            updatePlayerStats(match);
            
            saveData();
            
            showMatchCompletedOptions(match);
        }

        function showMatchCompletedOptions(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            if (!homeTeam || !awayTeam) {
                alert('Errore: squadre non trovate');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>‚úÖ Partita Completata!</h3>
                    <p><strong>${homeTeam.name} ${match.homeScore || 0} - ${match.awayScore || 0} ${awayTeam.name}</strong></p>
                    <p>Campo: ${match.field}</p>
                    
                    <div style="margin: 20px 0;">
                        <h4>Invia i risultati all'organizzatore:</h4>
                        <div style="display: grid; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="sendMatchByWhatsApp(${match.id})" style="background: #25D366;">
                                üì± Invia via WhatsApp
                            </button>
                            <button class="btn btn-warning" onclick="copyMatchData(${match.id})">
                                üìã Copia Dati negli Appunti
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="closeMatchCompletedModal()">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function sendMatchByWhatsApp(matchId) {
            const report = generateMatchReport(matchId);
            const encodedReport = encodeURIComponent(report);
            
            const organizerPhone = prompt('Inserisci numero WhatsApp organizzatore (con prefisso, es: +393401234567):', '+39');
            if (!organizerPhone || organizerPhone === '+39') return;
            
            const cleanPhone = organizerPhone.replace(/[^0-9]/g, '');
            const whatsappLink = `https://wa.me/${cleanPhone}?text=${encodedReport}`;
            
            try {
                window.open(whatsappLink, '_blank');
                showNotification('‚úÖ WhatsApp aperto! Se non funziona, usa "Copia Dati negli Appunti".');
                closeMatchCompletedModal();
            } catch (error) {
                alert('Errore WhatsApp: ' + error.message);
                copyMatchData(matchId);
            }
        }

        function copyMatchData(matchId) {
            const report = generateMatchReport(matchId);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => {
                    showNotification('‚úÖ Dati della partita copiati negli appunti! Ora puoi incollarli dove preferisci.');
                    closeMatchCompletedModal();
                }).catch(() => {
                    fallbackCopyTextToClipboard(report);
                });
            } else {
                fallbackCopyTextToClipboard(report);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('‚úÖ Dati della partita copiati negli appunti!');
                closeMatchCompletedModal();
            } catch (err) {
                alert('‚ùå Impossibile copiare automaticamente. Seleziona e copia manualmente il testo che apparir√†.');
                prompt('Copia questo testo:', text);
            }
            
            document.body.removeChild(textArea);
        }

        function generateMatchReport(matchId) {
            const match = matches.find(m => m.id === matchId);
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            let report = `üèÜ REPORT PARTITA PALLASCOUT üèÜ\n\n`;
            report += `üìÖ Data: ${new Date(match.completedAt || new Date()).toLocaleString('it-IT')}\n`;
            report += `üèüÔ∏è Campo: ${match.field}\n`;
            report += `üìä Risultato: ${homeTeam.name} ${match.homeScore || 0} - ${match.awayScore || 0} ${awayTeam.name}\n\n`;
            
            // Statistiche squadra casa
            report += `üè† ${homeTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            homeTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.homeMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            // Statistiche squadra ospite  
            report += `\nüöå ${awayTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            awayTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.awayMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            report += `\nüìã ARBITRO: ${getArbitratorName() || 'N/D'}\n`;
            report += `\nüî¢ ID PARTITA: ${match.id}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            report += `Generato da: Torneo Pallascout App`;
            
            return report;
        }

        function closeMatchCompletedModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            updateRefereeMatchSelect();
            document.getElementById('refereePanel').innerHTML = '';
        }

        function sendMatchByWhatsApp(matchId) {
            const report = generateMatchReport(matchId);
            const encodedReport = encodeURIComponent(report);
            
            const organizerPhone = prompt('Inserisci numero WhatsApp organizzatore (con prefisso, es: +393401234567):', '+39');
            if (!organizerPhone || organizerPhone === '+39') return;
            
            const cleanPhone = organizerPhone.replace(/[^0-9]/g, '');
            const whatsappLink = `https://wa.me/${cleanPhone}?text=${encodedReport}`;
            
            try {
                window.open(whatsappLink, '_blank');
                alert('‚úÖ WhatsApp aperto! Se non funziona, usa "Copia Dati negli Appunti".');
                closeMatchCompletedModal();
            } catch (error) {
                alert('Errore WhatsApp: ' + error.message);
                copyMatchData(matchId);
            }
        }

        function copyMatchData(matchId) {
            const report = generateMatchReport(matchId);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => {
                    alert('‚úÖ Dati della partita copiati negli appunti! Ora puoi incollarli dove preferisci.');
                    closeMatchCompletedModal();
                }).catch(() => {
                    fallbackCopyTextToClipboard(report);
                });
            } else {
                fallbackCopyTextToClipboard(report);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Dati della partita copiati negli appunti!');
                closeMatchCompletedModal();
            } catch (err) {
                alert('‚ùå Impossibile copiare automaticamente. Seleziona e copia manualmente il testo che apparir√†.');
                prompt('Copia questo testo:', text);
            }
            
            document.body.removeChild(textArea);
        }

        function generateMatchReport(matchId) {
            const match = matches.find(m => m.id === matchId);
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            let report = `üèÜ REPORT PARTITA PALLASCOUT üèÜ\n\n`;
            report += `üìÖ Data: ${new Date(match.completedAt || new Date()).toLocaleString('it-IT')}\n`;
            report += `üèüÔ∏è Campo: ${match.field}\n`;
            report += `üìä Risultato: ${homeTeam.name} ${match.homeScore || 0} - ${match.awayScore || 0} ${awayTeam.name}\n\n`;
            
            // Statistiche squadra casa
            report += `üè† ${homeTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            homeTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.homeMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            // Statistiche squadra ospite  
            report += `\nüöå ${awayTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            awayTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.awayMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            report += `\nüìã ARBITRO: ${getArbitratorName() || 'N/D'}\n`;
            report += `\nüî¢ ID PARTITA: ${match.id}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            report += `Generato da: Torneo Pallascout App`;
            
            return report;
        }

        function closeMatchCompletedModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            updateRefereeMatchSelect();
            document.getElementById('refereePanel').innerHTML = '';
        }

        function updateTeamStats(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);

            if (!homeTeam || !awayTeam) return;
            if (match.statsUpdated) return;

            homeTeam.stats.matches++;
            homeTeam.stats.goalsFor += match.homeScore || 0;
            homeTeam.stats.goalsAgainst += match.awayScore || 0;

            awayTeam.stats.matches++;
            awayTeam.stats.goalsFor += match.awayScore || 0;
            awayTeam.stats.goalsAgainst += match.homeScore || 0;

            if ((match.homeScore || 0) > (match.awayScore || 0)) {
                homeTeam.stats.wins++;
                homeTeam.stats.points += 3;
                awayTeam.stats.losses++;
            } else if ((match.homeScore || 0) < (match.awayScore || 0)) {
                awayTeam.stats.wins++;
                awayTeam.stats.points += 3;
                homeTeam.stats.losses++;
            } else {
                homeTeam.stats.draws++;
                awayTeam.stats.draws++;
                homeTeam.stats.points += 1;
                awayTeam.stats.points += 1;
            }

            if (match.playerStats) {
                homeTeam.players.forEach(player => {
                    if (match.playerStats[player.id]) {
                        homeTeam.stats.scalpFor += match.playerStats[player.id].scalps || 0;
                    }
                });

                awayTeam.players.forEach(player => {
                    if (match.playerStats[player.id]) {
                        awayTeam.stats.scalpFor += match.playerStats[player.id].scalps || 0;
                    }
                });
            }

            match.statsUpdated = true;
        }

        function updatePlayerStats(match) {
            if (match.playerStatsUpdated) return;

            if (match.playerStats) {
                Object.keys(match.playerStats).forEach(playerId => {
                    const playerIdInt = parseInt(playerId);
                    let player = null;
                    
                    teams.forEach(team => {
                        const foundPlayer = team.players.find(p => p.id === playerIdInt);
                        if (foundPlayer) player = foundPlayer;
                    });
                    
                    if (player && match.playerStats[playerId]) {
                        player.stats.goals += match.playerStats[playerId].goals || 0;
                        player.stats.scalps += match.playerStats[playerId].scalps || 0;
                    }
                });
            }

            if (match.homeMVP) {
                teams.forEach(team => {
                    const player = team.players.find(p => p.id === match.homeMVP);
                    if (player) player.stats.mvp++;
                });
            }
            
            if (match.awayMVP) {
                teams.forEach(team => {
                    const player = team.players.find(p => p.id === match.awayMVP);
                    if (player) player.stats.mvp++;
                });
            }

            match.playerStatsUpdated = true;
        }

        function displayStandings() {
            const standingsTable = document.getElementById('standingsTable');
            
            const sortedTeams = [...teams].sort((a, b) => {
                if (b.stats.points !== a.stats.points) {
                    return b.stats.points - a.stats.points;
                }
                const diffA = a.stats.goalsFor - a.stats.goalsAgainst;
                const diffB = b.stats.goalsFor - b.stats.goalsAgainst;
                return diffB - diffA;
            });

            let tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Squadra</th>
                            <th>G</th>
                            <th>V</th>
                            <th>P</th>
                            <th>S</th>
                            <th>GF</th>
                            <th>GS</th>
                            <th>DR</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedTeams.forEach((team, index) => {
                const goalDiff = team.stats.goalsFor - team.stats.goalsAgainst;
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${team.name}</strong></td>
                        <td>${team.stats.matches}</td>
                        <td>${team.stats.wins}</td>
                        <td>${team.stats.draws}</td>
                        <td>${team.stats.losses}</td>
                        <td>${team.stats.goalsFor}</td>
                        <td>${team.stats.goalsAgainst}</td>
                        <td>${goalDiff > 0 ? '+' : ''}${goalDiff}</td>
                        <td><strong>${team.stats.points}</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            standingsTable.innerHTML = tableHTML;
        }

        function displayStats() {
            const statsContent = document.getElementById('statsContent');
            
            const allPlayers = [];
            teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name
                    });
                });
            });

            const topScorers = [...allPlayers]
                .filter(p => p.stats.goals > 0)
                .sort((a, b) => b.stats.goals - a.stats.goals)
                .slice(0, 10);

            const topScalpers = [...allPlayers]
                .filter(p => p.stats.scalps > 0)
                .sort((a, b) => b.stats.scalps - a.stats.scalps)
                .slice(0, 10);

            const topMVPs = [...allPlayers]
                .filter(p => p.stats.mvp > 0)
                .sort((a, b) => b.stats.mvp - a.stats.mvp)
                .slice(0, 10);

            let statsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3>ü•Ö Migliori Marcatori</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>Gol</th></tr>
                            </thead>
                            <tbody>
                                ${topScorers.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.goals}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>‚öîÔ∏è Migliori Scalpers</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>Scalpi</th></tr>
                            </thead>
                            <tbody>
                                ${topScalpers.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.scalps}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>üèÜ Pi√π MVP</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>MVP</th></tr>
                            </thead>
                            <tbody>
                                ${topMVPs.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.mvp}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>üìä Statistiche Generali</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div>
                            <h4>${teams.length}</h4>
                            <p>Squadre Registrate</p>
                        </div>
                        <div>
                            <h4>${allPlayers.length}</h4>
                            <p>Giocatori Registrati</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'completed').length}</h4>
                            <p>Partite Completate</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'in_progress').length}</h4>
                            <p>Partite in Corso</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'scheduled').length}</h4>
                            <p>Partite Programmate</p>
                        </div>
                        <div>
                            <h4>${allPlayers.reduce((sum, p) => sum + p.stats.goals, 0)}</h4>
                            <p>Gol Totali</p>
                        </div>
                        <div>
                            <h4>${allPlayers.reduce((sum, p) => sum + p.stats.scalps, 0)}</h4>
                            <p>Scalpi Totali</p>
                        </div>
                    </div>
                </div>
            `;

            statsContent.innerHTML = statsHTML;
        }

        function getArbitratorName() {
            return localStorage.getItem('arbitrator_name') || null;
        }

        function setArbitratorName() {
            const name = prompt('Inserisci il tuo nome (arbitro):', getArbitratorName() || '');
            if (name) {
                localStorage.setItem('arbitrator_name', name);
                alert(`Nome arbitro salvato: ${name}`);
                updateArbitratorDisplay();
            }
        }

        // FUNZIONI ADMIN
        function processSingleReport() {
            const reportText = document.getElementById('singleReportInput').value.trim();
            if (!reportText) {
                alert('Inserisci il report da elaborare');
                return;
            }
            
            const result = parseReportText(reportText);
            if (result.success) {
                alert(result.message);
                document.getElementById('singleReportInput').value = '';
                displayStandings();
                displayStats();
                updateMatchStatusSummary();
            } else {
                alert('Errore: ' + result.message);
            }
        }

        function processBulkReports() {
            const bulkText = document.getElementById('bulkReportsInput').value.trim();
            if (!bulkText) {
                alert('Inserisci i report da elaborare');
                return;
            }
            
            const reports = bulkText.split('üèÜ REPORT PARTITA PALLASCOUT üèÜ').filter(r => r.trim());
            
            let processed = 0;
            let errors = [];
            
            reports.forEach((reportText, index) => {
                if (reportText.trim()) {
                    const fullReport = 'üèÜ REPORT PARTITA PALLASCOUT üèÜ' + reportText;
                    const result = parseReportText(fullReport);
                    
                    if (result.success) {
                        processed++;
                    } else {
                        errors.push(`Report ${index + 1}: ${result.message}`);
                    }
                }
            });
            
            let message = `‚úÖ Elaborati ${processed} report su ${reports.length}`;
            if (errors.length > 0) {
                message += `\\n\\n‚ùå Errori:\\n${errors.join('\\n')}`;
            }
            
            alert(message);
            document.getElementById('bulkReportsInput').value = '';
            displayStandings();
            displayStats();
            updateMatchStatusSummary();
        }

        function parseReportText(reportText) {
            try {
                const idMatch = reportText.match(/üî¢ ID PARTITA: (\\d+)/);
                if (!idMatch) {
                    return { success: false, message: 'Report non valido: ID partita non trovato' };
                }
                
                const matchId = parseInt(idMatch[1]);
                const match = matches.find(m => m.id === matchId);
                
                if (!match) {
                    return { success: false, message: 'Partita non trovata nel sistema' };
                }
                
                const scoreMatch = reportText.match(/üìä Risultato: (.+) (\\d+) - (\\d+) (.+)/);
                if (scoreMatch) {
                    const homeScore = parseInt(scoreMatch[2]);
                    const awayScore = parseInt(scoreMatch[3]);
                    match.homeScore = homeScore;
                    match.awayScore = awayScore;
                }
                
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                
                match.playerStats = {};
                match.homeMVP = null;
                match.awayMVP = null;
                
                const homeSection = reportText.match(new RegExp(`üè† ${homeTeam.name.toUpperCase()}[\\\\s\\\\S]*?(?=üöå|$)`));
                if (homeSection) {
                    parseTeamStats(homeSection[0], homeTeam, match, 'home');
                }
                
                const awaySection = reportText.match(new RegExp(`üöå ${awayTeam.name.toUpperCase()}[\\\\s\\\\S]*?(?=üìã|$)`));
                if (awaySection) {
                    parseTeamStats(awaySection[0], awayTeam, match, 'away');
                }
                
                match.status = 'completed';
                if (!match.completedAt) {
                    match.completedAt = new Date().toISOString();
                }
                
                // Reset flag per aggiornare statistiche
                match.statsUpdated = false;
                match.playerStatsUpdated = false;
                
                updateTeamStats(match);
                updatePlayerStats(match);
                saveData();
                
                return { 
                    success: true, 
                    message: `‚úÖ Report elaborato con successo!\\n\\nPartita: ${homeTeam.name} vs ${awayTeam.name}\\nRisultato: ${match.homeScore} - ${match.awayScore}\\nStato: Aggiornato nel sistema` 
                };
                
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        function parseTeamStats(sectionText, team, match, side) {
            const lines = sectionText.split('\\n');
            
            lines.forEach(line => {
                const statMatch = line.match(/#(\\d+) (.+?): (\\d+) gol, (\\d+) scalpi(.*)$/);
                if (statMatch) {
                    const playerNumber = parseInt(statMatch[1]);
                    const goals = parseInt(statMatch[3]);
                    const scalps = parseInt(statMatch[4]);
                    const isMVP = statMatch[5].includes('‚≠ê MVP');
                    
                    const player = team.players.find(p => p.number === playerNumber);
                    if (player) {
                        match.playerStats[player.id] = { goals, scalps };
                        if (isMVP) {
                            if (side === 'home') {
                                match.homeMVP = player.id;
                            } else {
                                match.awayMVP = player.id;
                            }
                        }
                    }
                }
            });
        }

        function updateMatchStatusSummary() {
            const summary = document.getElementById('matchStatusSummary');
            if (!summary) return;
            
            const completed = matches.filter(m => m.status === 'completed').length;
            const inProgress = matches.filter(m => m.status === 'in_progress').length;
            const scheduled = matches.filter(m => m.status === 'scheduled').length;
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                    <div style="padding: 15px; background: #d4edda; border-radius: 8px;">
                        <h4>${completed}</h4>
                        <p>Completate</p>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <h4>${inProgress}</h4>
                        <p>In Corso</p>
                    </div>
                    <div style="padding: 15px; background: #f8d7da; border-radius: 8px;">
                        <h4>${scheduled}</h4>
                        <p>Programmate</p>
                    </div>
                    <div style="padding: 15px; background: #cce5ff; border-radius: 8px;">
                        <h4>${matches.length}</h4>
                        <p>Totali</p>
                    </div>
                </div>
            `;
        }

        function showDetailedMatchStatus() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            let content = `
                <div class="modal-content">
                    <span class="close" onclick="this.remove()">&times;</span>
                    <h3>üìã Stato Dettagliato Partite</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            matches.forEach(match => {
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                const statusEmoji = match.status === 'completed' ? '‚úÖ' : match.status === 'in_progress' ? '‚è≥' : 'üìÖ';
                
                content += `
                    <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between;">
                        <span>${statusEmoji} ${homeTeam.name} vs ${awayTeam.name} - ${match.field}</span>
                        <span>${match.homeScore || 0} - ${match.awayScore || 0}</span>
                    </div>
                `;
            });
            
            content += `
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        function exportCompleteJSON() {
            const completeData = {
                tournament: {
                    name: "Torneo Pallascout",
                    created: new Date().toISOString(),
                    version: "1.0"
                },
                teams: teams,
                matches: matches,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(completeData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `torneo_pallascout_completo_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportExcelFormat() {
            let csv = "CLASSIFICA\\n";
            csv += "Posizione,Squadra,Partite,Vittorie,Pareggi,Sconfitte,Gol Fatti,Gol Subiti,Differenza Reti,Punti\\n";
            
            const sortedTeams = [...teams].sort((a, b) => {
                if (b.stats.points !== a.stats.points) {
                    return b.stats.points - a.stats.points;
                }
                return (b.stats.goalsFor - b.stats.goalsAgainst) - (a.stats.goalsFor - a.stats.goalsAgainst);
            });

            sortedTeams.forEach((team, index) => {
                const goalDiff = team.stats.goalsFor - team.stats.goalsAgainst;
                csv += `${index + 1},${team.name},${team.stats.matches},${team.stats.wins},${team.stats.draws},${team.stats.losses},${team.stats.goalsFor},${team.stats.goalsAgainst},${goalDiff},${team.stats.points}\\n`;
            });

            csv += "\\n\\nSTATISTICHE GIOCATORI\\n";
            csv += "Giocatore,Numero,Squadra,Gol,Scalpi,MVP\\n";
            
            teams.forEach(team => {
                team.players.forEach(player => {
                    csv += `${player.name},${player.number},${team.name},${player.stats.goals},${player.stats.scalps},${player.stats.mvp}\\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `torneo_pallascout_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportPrintableReport() {
            const report = generatePrintableReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_torneo_pallascout_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generatePrintableReport() {
            let report = `üèÜ TORNEO PALLASCOUT - REPORT FINALE üèÜ\\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n`;
            report += `üìÖ Generato il: ${new Date().toLocaleString('it-IT')}\\n\\n`;

            const sortedTeams = [...teams].sort((a, b) => {
                if (b.stats.points !== a.stats.points) {
                    return b.stats.points - a.stats.points;
                }
                return (b.stats.goalsFor - b.stats.goalsAgainst) - (a.stats.goalsFor - a.stats.goalsAgainst);
            });

            report += `üìä CLASSIFICA FINALE\\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;
            
            sortedTeams.forEach((team, index) => {
                const goalDiff = team.stats.goalsFor - team.stats.goalsAgainst;
                const diffStr = goalDiff > 0 ? `+${goalDiff}` : goalDiff.toString();
                report += `${(index + 1).toString().padStart(2)}¬∞ ${team.name.padEnd(20)} | Pts: ${team.stats.points.toString().padStart(3)}\\n`;
            });

            const allPlayers = [];
            teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name
                    });
                });
            });

            const topScorers = [...allPlayers].filter(p => p.stats.goals > 0).sort((a, b) => b.stats.goals - a.stats.goals).slice(0, 5);

            report += `\\nü•Ö TOP MARCATORI\\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;
            topScorers.forEach((player, index) => {
                report += `${index + 1}¬∞ #${player.number} ${player.name} (${player.teamName}) - ${player.stats.goals} gol\\n`;
            });

            report += `\\nüìä STATISTICHE GENERALI\\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;
            report += `Squadre: ${teams.length} | Partite completate: ${matches.filter(m => m.status === 'completed').length}\\n`;
            report += `Gol totali: ${allPlayers.reduce((sum, p) => sum + p.stats.goals, 0)}\\n`;

            return report;
        }

        function validateData() {
            let issues = [];
            
            teams.forEach(team => {
                if (team.players.length === 0) {
                    issues.push(`Squadra "${team.name}" non ha giocatori`);
                }
            });
            
            if (issues.length === 0) {
                alert('‚úÖ Validazione completata: nessun problema trovato!');
            } else {
                alert(`‚ùå Trovati ${issues.length} problemi:\\n\\n${issues.join('\\n')}`);
            }
        }

        function backupData() {
            const backupData = {
                timestamp: new Date().toISOString(),
                teams: teams,
                matches: matches,
                version: "1.0",
                type: "backup"
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_pallascout_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup creato e scaricato!');
        }

        function importCompleteData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.teams && data.matches) {
                        const overwrite = confirm('Vuoi sovrascrivere i dati esistenti o unire con quelli attuali?\\n\\nOK = Sovrascrivi\\nAnnulla = Unisci');
                        
                        if (overwrite) {
                            teams = data.teams;
                            matches = data.matches;
                        } else {
                            // Merge dei dati
                            data.teams.forEach(importedTeam => {
                                const existingTeam = teams.find(t => t.name === importedTeam.name);
                                if (!existingTeam) {
                                    teams.push(importedTeam);
                                }
                            });
                            
                            data.matches.forEach(importedMatch => {
                                const existingMatch = matches.find(m => m.id === importedMatch.id);
                                if (!existingMatch) {
                                    matches.push(importedMatch);
                                }
                            });
                        }
                        
                        saveData();
                        alert('‚úÖ Dati importati con successo!');
                        displayTeams();
                        displayStandings();
                        displayStats();
                        updateMatchStatusSummary();
                    } else {
                        alert('‚ùå File non valido');
                    }
                } catch (error) {
                    alert('‚ùå Errore nell\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function resetTournament() {
            const confirmation = prompt('ATTENZIONE! Questa operazione canceller√† TUTTI i dati.\\n\\nScrivi "RESET TORNEO" per confermare:', '');
            if (confirmation === 'RESET TORNEO') {
                teams = [];
                matches = [];
                localStorage.removeItem('pallascout_teams');
                localStorage.removeItem('pallascout_matches');
                alert('üóëÔ∏è Torneo resettato completamente!');
                displayTeams();
                updateMatchStatusSummary();
            } else {
                alert('Reset annullato.');
            }
        }

        // IMPORT TEAMS FROM TEXT (SIMPLIFIED AND RELIABLE)
        function importTeamsFromText() {
            const data = document.getElementById('importTeamsData').value.trim();
            
            if (!data) {
                alert('‚ùå Incolla i dati da Google Sheets prima di importare!');
                return;
            }
            
            try {
                const lines = data.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    alert('‚ùå Nessun dato trovato!');
                    return;
                }
                
                let importedTeams = 0;
                let importedPlayers = 0;
                let errors = [];
                const teamMap = new Map();
                
                lines.forEach((line, index) => {
                    // Prova diversi separatori: tab, virgola, spazi multipli
                    let columns;
                    
                    if (line.includes('\t')) {
                        columns = line.split('\t');
                    } else if (line.includes(',')) {
                        columns = line.split(',');
                    } else {
                        columns = line.split(/\s{2,}/); // 2 o pi√π spazi
                    }
                    
                    columns = columns.map(col => col.trim()).filter(col => col);
                    
                    if (columns.length >= 3) {
                        const squadra = columns[0];
                        const nomeGiocatore = columns[1];
                        const numeroMaglia = parseInt(columns[2]);
                        
                        if (!squadra || !nomeGiocatore || isNaN(numeroMaglia)) {
                            errors.push(`Riga ${index + 1}: dati incompleti`);
                            return;
                        }
                        
                        // Crea squadra se non esiste
                        if (!teamMap.has(squadra)) {
                            const team = {
                                id: Date.now() + Math.random() * 1000,
                                name: squadra,
                                players: [],
                                stats: {
                                    matches: 0, wins: 0, draws: 0, losses: 0,
                                    points: 0, goalsFor: 0, goalsAgainst: 0,
                                    scalpFor: 0, scalpAgainst: 0
                                }
                            };
                            teams.push(team);
                            teamMap.set(squadra, team);
                            importedTeams++;
                        }
                        
                        const team = teamMap.get(squadra);
                        
                        // Controlla numero maglia duplicato
                        if (team.players.some(p => p.number === numeroMaglia)) {
                            errors.push(`Riga ${index + 1}: numero ${numeroMaglia} gi√† usato in ${squadra}`);
                            return;
                        }
                        
                        // Aggiungi giocatore
                        const player = {
                            id: Date.now() + Math.random() * 1000,
                            name: nomeGiocatore,
                            number: numeroMaglia,
                            stats: { goals: 0, scalps: 0, mvp: 0 }
                        };
                        team.players.push(player);
                        importedPlayers++;
                        
                    } else {
                        errors.push(`Riga ${index + 1}: formato non valido (servono 3 colonne)`);
                    }
                });
                
                if (importedPlayers === 0) {
                    alert('‚ùå Nessun giocatore importato! Controlla il formato dei dati.');
                    return;
                }
                
                saveData();
                displayTeams();
                document.getElementById('importTeamsData').value = '';
                
                // Messaggio di successo
                let message = `‚úÖ IMPORTAZIONE COMPLETATA!\n\n`;
                message += `üìä ${importedTeams} squadre importate\n`;
                message += `üë• ${importedPlayers} giocatori importati`;
                
                if (errors.length > 0) {
                    message += `\n\n‚ö†Ô∏è Avvisi (${errors.length}):\n`;
                    message += errors.slice(0, 5).join('\n');
                    if (errors.length > 5) {
                        message += `\n... e altri ${errors.length - 5} avvisi`;
                    }
                }
                
                alert(message);
                showNotification('‚úÖ Importazione completata con successo!');
                
            } catch (error) {
                console.error('Errore importazione:', error);
                alert('‚ùå Errore nell\'importazione: ' + error.message);
            }
        }
        
        function showImportExample() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="this.remove()">&times;</span>
                    <h3>üìã Esempi di Formato Importazione</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>‚úÖ Formato 1: Separato da TAB (Google Sheets standard)</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;">
Squadra A    Mario Rossi      10<br>
Squadra A    Luigi Verdi      7<br>
Squadra A    Paolo Bianchi    5<br>
Squadra B    Andrea Neri      9<br>
Squadra B    Marco Blu        11
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>‚úÖ Formato 2: Separato da virgole (CSV)</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;">
Squadra A, Mario Rossi, 10<br>
Squadra A, Luigi Verdi, 7<br>
Squadra A, Paolo Bianchi, 5<br>
Squadra B, Andrea Neri, 9<br>
Squadra B, Marco Blu, 11
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4>üìù Come copiare da Google Sheets:</h4>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Apri il tuo Google Sheets</li>
                            <li>Seleziona tutte le celle (trascina o Ctrl+A)</li>
                            <li>Copia (Ctrl+C o Cmd+C)</li>
                            <li>Incolla nell'app (Ctrl+V o Cmd+V)</li>
                            <li>Clicca "Importa Dati"</li>
                        </ol>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <h4>‚ö†Ô∏è Regole importanti:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Ogni riga = un giocatore</li>
                            <li>Tre colonne: <strong>Squadra</strong>, <strong>Nome</strong>, <strong>Numero</strong></li>
                            <li>I numeri di maglia devono essere unici per squadra</li>
                            <li>Non servono intestazioni (header)</li>
                        </ul>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function downloadTemplate() {
            const template = `Squadra A\tMario Rossi\t10
Squadra A\tLuigi Verdi\t7
Squadra A\tPaolo Bianchi\t5
Squadra A\tAndrea Gialli\t3
Squadra A\tMarco Blu\t1
Squadra B\tGiovanni Neri\t9
Squadra B\tFrancesco Rosa\t11
Squadra B\tAlessandro Oro\t8
Squadra B\tLuca Argento\t4
Squadra B\tMatteo Bronzo\t2
Squadra C\tDavide Verde\t10
Squadra C\tSimone Celeste\t7
Squadra C\tRoberto Viola\t6`;

            const blob = new Blob([template], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_squadre_pallascout.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('üì• Template scaricato! Modificalo e importalo nell\'app.');
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            displayTeams();
            initializePWA();
        });

        // PWA FUNCTIONALITY
        let deferredPrompt;
        let isStandalone = false;

        function initializePWA() {
            // Controlla se gi√† installata
            isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            
            // Registra Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('Service Worker registrato con successo:', registration);
                }).catch(function(error) {
                    console.log('Registrazione Service Worker fallita:', error);
                });
            }

            // Gestisci beforeinstallprompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });

            // Gestisci installazione completata
            window.addEventListener('appinstalled', () => {
                hideInstallBanner();
                console.log('PWA installata con successo');
                showNotification('‚úÖ App installata con successo!');
            });

            // Gestisci online/offline
            window.addEventListener('online', () => {
                document.getElementById('offlineIndicator').classList.remove('show');
                showNotification('üåê Connessione ripristinata');
            });

            window.addEventListener('offline', () => {
                document.getElementById('offlineIndicator').classList.add('show');
                showNotification('üì° Modalit√† offline attivata');
            });

            // Event listeners per install banner
            document.getElementById('installBtn').addEventListener('click', installApp);
            document.getElementById('dismissBtn').addEventListener('click', hideInstallBanner);

            // Nascondi banner se gi√† installata
            if (isStandalone) {
                hideInstallBanner();
            }
        }

        function showInstallBanner() {
            if (!isStandalone) {
                document.getElementById('installBanner').classList.add('show');
            }
        }

        function hideInstallBanner() {
            document.getElementById('installBanner').classList.remove('show');
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Utente ha accettato l\'installazione');
                    } else {
                        console.log('Utente ha rifiutato l\'installazione');
                    }
                    deferredPrompt = null;
                });
                hideInstallBanner();
            }
        }

        function showNotification(message) {
            // Crea notifica temporanea
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #2ecc71;
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: bold;
                z-index: 1002;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                animation: slideDown 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Rimuovi dopo 3 secondi
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Aggiungi stili per animazioni
        const additionalStyles = `
            <style>
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
                
                @keyframes slideUp {
                    from { transform: translateX(-50%) translateY(0); opacity: 1; }
                    to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                }

                /* PWA Splash screen styles */
                @media (display-mode: standalone) {
                    body {
                        -webkit-user-select: none;
                        user-select: none;
                    }
                }

                /* Improve touch targets for mobile */
                @media (max-width: 768px) {
                    .btn, .nav-tab {
                        min-height: 44px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                }
            </style>
        `;

        // Aggiungi gli stili aggiuntivi
        document.addEventListener('DOMContentLoaded', function() {
            document.head.insertAdjacentHTML('beforeend', additionalStyles);
        });
    </script>
</body>
</html>