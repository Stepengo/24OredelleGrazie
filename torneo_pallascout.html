<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Pallascout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .player-list {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .match-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .teams-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .team-info {
            text-align: center;
            flex: 1;
        }

        .vs {
            margin: 0 20px;
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .stats-input {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stats-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #3498db;
            color: white;
        }

        .table tr:hover {
            background: #f5f5f5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .player-stats {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                font-size: 14px;
                padding: 8px 16px;
            }
            
            .match-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-input {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Torneo Pallascout</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('teams')">Squadre</button>
                <button class="nav-tab" onclick="showTab('matches')">Partite</button>
                <button class="nav-tab" onclick="showTab('referee')">Arbitro</button>
                <button class="nav-tab" onclick="showTab('standings')">Classifica</button>
                <button class="nav-tab" onclick="showTab('stats')">Statistiche</button>
            </div>
        </div>

        <!-- Tab Squadre -->
        <div id="teams" class="tab-content active">
            <h2>Gestione Squadre</h2>
            <div class="form-group">
                <label>Nome Squadra:</label>
                <input type="text" id="teamName" placeholder="Inserisci nome squadra">
            </div>
            <button class="btn btn-primary" onclick="addTeam()">Aggiungi Squadra</button>
            
            <div id="teamsList"></div>
        </div>

        <!-- Tab Partite -->
        <div id="matches" class="tab-content">
            <h2>Gestione Partite</h2>
            <div class="form-group">
                <label>Squadra Casa:</label>
                <select id="homeTeam"></select>
            </div>
            <div class="form-group">
                <label>Squadra Ospite:</label>
                <select id="awayTeam"></select>
            </div>
            <div class="form-group">
                <label>Campo:</label>
                <input type="text" id="matchField" placeholder="Campo 1">
            </div>
            <button class="btn btn-primary" onclick="createMatch()">Crea Partita</button>
            
            <div id="matchesList"></div>
        </div>

        <!-- Tab Arbitro -->
        <div id="referee" class="tab-content">
            <h2>Pannello Arbitro</h2>
            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn btn-info" onclick="setArbitratorName()">üë§ Imposta Nome Arbitro</button>
                <span id="arbitratorDisplay" style="margin-left: 15px; font-weight: bold;"></span>
            </div>
            <div class="form-group">
                <label>Seleziona Partita da Arbitrare:</label>
                <select id="refereeMatchSelect" onchange="loadRefereeMatch()"></select>
            </div>
            <div id="refereePanel"></div>
        </div>

        <!-- Tab Classifica -->
        <div id="standings" class="tab-content">
            <h2>Classifica Generale</h2>
            <div id="standingsTable"></div>
        </div>

        <!-- Tab Statistiche -->
        <div id="stats" class="tab-content">
            <h2>Statistiche</h2>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Modal per aggiungere giocatori -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePlayerModal()">&times;</span>
            <h3 id="modalTitle">Aggiungi Giocatore</h3>
            <div class="form-group">
                <label>Nome Giocatore:</label>
                <input type="text" id="playerName">
            </div>
            <div class="form-group">
                <label>Numero Maglia:</label>
                <input type="number" id="playerNumber" min="1">
            </div>
            <button class="btn btn-primary" onclick="addPlayer()">Aggiungi</button>
        </div>
    </div>

    <script>
        // Strutture dati
        let teams = JSON.parse(localStorage.getItem('pallascout_teams') || '[]');
        let matches = JSON.parse(localStorage.getItem('pallascout_matches') || '[]');
        let currentTeamId = null;

        // Funzioni di salvataggio
        function saveData() {
            localStorage.setItem('pallascout_teams', JSON.stringify(teams));
            localStorage.setItem('pallascout_matches', JSON.stringify(matches));
        }

        // Gestione tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'matches') {
                updateTeamSelects();
                displayMatches();
            } else if (tabName === 'referee') {
                updateRefereeMatchSelect();
                updateArbitratorDisplay();
            } else if (tabName === 'standings') {
                displayStandings();
            } else if (tabName === 'stats') {
                displayStats();
            } else if (tabName === 'teams') {
                displayTeams();
            }
        }

        // Gestione squadre
        function addTeam() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Inserisci un nome per la squadra');
                return;
            }

            const team = {
                id: Date.now(),
                name: teamName,
                players: [],
                stats: {
                    matches: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0,
                    goalsFor: 0,
                    goalsAgainst: 0,
                    scalpFor: 0,
                    scalpAgainst: 0
                }
            };

            teams.push(team);
            saveData();
            document.getElementById('teamName').value = '';
            displayTeams();
        }

        function displayTeams() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';

            teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = 'card';
                teamCard.innerHTML = `
                    <h3>${team.name}</h3>
                    <p>Giocatori: ${team.players.length}</p>
                    <div class="player-list" id="players-${team.id}">
                        ${team.players.map(player => `
                            <div class="player-item">
                                <span>#${player.number} - ${player.name}</span>
                                <button class="btn btn-danger" onclick="removePlayer(${team.id}, ${player.id})">Rimuovi</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-success" onclick="openPlayerModal(${team.id})">Aggiungi Giocatore</button>
                    <button class="btn btn-danger" onclick="removeTeam(${team.id})">Elimina Squadra</button>
                `;
                teamsList.appendChild(teamCard);
            });
        }

        function openPlayerModal(teamId) {
            currentTeamId = teamId;
            const team = teams.find(t => t.id === teamId);
            document.getElementById('modalTitle').textContent = `Aggiungi Giocatore - ${team.name}`;
            document.getElementById('playerModal').style.display = 'block';
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
            document.getElementById('playerName').value = '';
            document.getElementById('playerNumber').value = '';
        }

        function addPlayer() {
            const playerName = document.getElementById('playerName').value.trim();
            const playerNumber = parseInt(document.getElementById('playerNumber').value);
            
            if (!playerName || !playerNumber) {
                alert('Inserisci nome e numero del giocatore');
                return;
            }

            const team = teams.find(t => t.id === currentTeamId);
            if (team.players.some(p => p.number === playerNumber)) {
                alert('Numero maglia gi√† utilizzato');
                return;
            }

            const player = {
                id: Date.now(),
                name: playerName,
                number: playerNumber,
                stats: {
                    goals: 0,
                    scalps: 0,
                    mvp: 0
                }
            };

            team.players.push(player);
            saveData();
            closePlayerModal();
            displayTeams();
        }

        function removePlayer(teamId, playerId) {
            const team = teams.find(t => t.id === teamId);
            team.players = team.players.filter(p => p.id !== playerId);
            saveData();
            displayTeams();
        }

        function removeTeam(teamId) {
            if (confirm('Sei sicuro di voler eliminare questa squadra?')) {
                teams = teams.filter(t => t.id !== teamId);
                saveData();
                displayTeams();
            }
        }

        // Gestione partite
        function updateTeamSelects() {
            const homeSelect = document.getElementById('homeTeam');
            const awaySelect = document.getElementById('awayTeam');
            
            const options = '<option value="">Seleziona squadra</option>' + 
                          teams.map(team => `<option value="${team.id}">${team.name}</option>`).join('');
            
            homeSelect.innerHTML = options;
            awaySelect.innerHTML = options;
        }

        function createMatch() {
            const homeTeamId = parseInt(document.getElementById('homeTeam').value);
            const awayTeamId = parseInt(document.getElementById('awayTeam').value);
            const field = document.getElementById('matchField').value.trim();

            if (!homeTeamId || !awayTeamId || homeTeamId === awayTeamId) {
                alert('Seleziona due squadre diverse');
                return;
            }

            const match = {
                id: Date.now(),
                homeTeamId,
                awayTeamId,
                field: field || 'Campo TBD',
                status: 'scheduled', // scheduled, in_progress, completed
                homeScore: 0,
                awayScore: 0,
                playerStats: {},
                homeMVP: null,
                awayMVP: null,
                startTime: new Date().toISOString()
            };

            matches.push(match);
            saveData();
            displayMatches();
            updateRefereeMatchSelect();
            
            // Reset form
            document.getElementById('homeTeam').value = '';
            document.getElementById('awayTeam').value = '';
            document.getElementById('matchField').value = '';
        }

        function displayMatches() {
            const matchesList = document.getElementById('matchesList');
            matchesList.innerHTML = '<div class="match-grid"></div>';
            const matchGrid = matchesList.querySelector('.match-grid');

            matches.forEach(match => {
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                
                if (!homeTeam || !awayTeam) return;

                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                matchCard.innerHTML = `
                    <div class="match-header">
                        <h4>${match.field}</h4>
                        <span class="badge">${getStatusText(match.status)}</span>
                    </div>
                    <div class="teams-display">
                        <div class="team-info">
                            <h5>${homeTeam.name}</h5>
                            <span class="score">${match.homeScore || 0}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team-info">
                            <h5>${awayTeam.name}</h5>
                            <span class="score">${match.awayScore || 0}</span>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="deleteMatch(${match.id})">Elimina</button>
                `;
                matchGrid.appendChild(matchCard);
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'scheduled': return 'Programmata';
                case 'in_progress': return 'In corso';
                case 'completed': return 'Completata';
                default: return 'Sconosciuto';
            }
        }

        function deleteMatch(matchId) {
            if (confirm('Sei sicuro di voler eliminare questa partita?')) {
                matches = matches.filter(m => m.id !== matchId);
                saveData();
                displayMatches();
                updateRefereeMatchSelect();
            }
        }

        // Gestione arbitro
        function updateRefereeMatchSelect() {
            const select = document.getElementById('refereeMatchSelect');
            if (!select) return;
            
            const availableMatches = matches.filter(m => m.status === 'scheduled' || m.status === 'in_progress');
            
            if (availableMatches.length === 0) {
                select.innerHTML = '<option value="">Nessuna partita disponibile</option>';
                return;
            }
            
            let optionsHTML = '<option value="">Seleziona partita da arbitrare</option>';
            
            availableMatches.forEach(match => {
                const homeTeam = teams.find(t => t.id === match.homeTeamId);
                const awayTeam = teams.find(t => t.id === match.awayTeamId);
                
                if (homeTeam && awayTeam) {
                    const status = match.status === 'in_progress' ? ' (In corso)' : '';
                    optionsHTML += `<option value="${match.id}">${homeTeam.name} vs ${awayTeam.name} - ${match.field}${status}</option>`;
                }
            });
            
            select.innerHTML = optionsHTML;
        }

        function updateArbitratorDisplay() {
            const display = document.getElementById('arbitratorDisplay');
            if (!display) return;
            
            const name = getArbitratorName();
            if (name) {
                display.textContent = `Arbitro: ${name}`;
                display.style.color = '#27ae60';
            } else {
                display.textContent = '(Nome non impostato - clicca per impostarlo)';
                display.style.color = '#e74c3c';
            }
        }

        function loadRefereeMatch() {
            const matchId = parseInt(document.getElementById('refereeMatchSelect').value);
            if (!matchId) {
                document.getElementById('refereePanel').innerHTML = '';
                return;
            }

            const match = matches.find(m => m.id === matchId);
            if (!match) {
                alert('Partita non trovata');
                return;
            }

            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);

            if (!homeTeam || !awayTeam) {
                alert('Errore: squadre della partita non trovate');
                return;
            }

            if (match.status === 'scheduled') {
                match.status = 'in_progress';
                saveData();
            }

            if (!match.playerStats) {
                match.playerStats = {};
            }

            document.getElementById('refereePanel').innerHTML = `
                <div class="card">
                    <h3>${homeTeam.name} vs ${awayTeam.name}</h3>
                    <div class="teams-display">
                        <div class="team-info">
                            <h4 id="homeScore">${homeTeam.name}: ${match.homeScore || 0}</h4>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team-info">
                            <h4 id="awayScore">${awayTeam.name}: ${match.awayScore || 0}</h4>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h4>${homeTeam.name}</h4>
                            <div id="homePlayersStats">
                                ${homeTeam.players.map(player => `
                                    <div class="player-stats">
                                        <strong>#${player.number} ${player.name}</strong>
                                        <div class="stats-input" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                            <input type="number" placeholder="Gol" min="0" 
                                                   value="${match.playerStats[player.id]?.goals || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'goals', this.value)">
                                            <input type="number" placeholder="Scalpi" min="0" 
                                                   value="${match.playerStats[player.id]?.scalps || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'scalps', this.value)">
                                            <label style="display: flex; align-items: center; justify-content: center;">
                                                <input type="radio" name="homeMVP" value="${player.id}" 
                                                       ${match.homeMVP === player.id ? 'checked' : ''}
                                                       onchange="updateMVP(${match.id}, 'home', ${player.id})"> MVP
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4>${awayTeam.name}</h4>
                            <div id="awayPlayersStats">
                                ${awayTeam.players.map(player => `
                                    <div class="player-stats">
                                        <strong>#${player.number} ${player.name}</strong>
                                        <div class="stats-input" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                            <input type="number" placeholder="Gol" min="0" 
                                                   value="${match.playerStats[player.id]?.goals || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'goals', this.value)">
                                            <input type="number" placeholder="Scalpi" min="0" 
                                                   value="${match.playerStats[player.id]?.scalps || 0}"
                                                   onchange="updatePlayerStat(${match.id}, ${player.id}, 'scalps', this.value)">
                                            <label style="display: flex; align-items: center; justify-content: center;">
                                                <input type="radio" name="awayMVP" value="${player.id}" 
                                                       ${match.awayMVP === player.id ? 'checked' : ''}
                                                       onchange="updateMVP(${match.id}, 'away', ${player.id})"> MVP
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-success" onclick="completeMatch(${match.id})">Termina Partita</button>
                        <button class="btn btn-warning" onclick="saveMatchProgress(${match.id})">Salva Progresso</button>
                    </div>
                </div>
            `;
        }

        function updatePlayerStat(matchId, playerId, stat, value) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            if (!match.playerStats) {
                match.playerStats = {};
            }
            
            if (!match.playerStats[playerId]) {
                match.playerStats[playerId] = { goals: 0, scalps: 0 };
            }
            
            match.playerStats[playerId][stat] = parseInt(value) || 0;
            
            calculateMatchScore(match);
            saveData();
            updateScoreDisplay(match);
        }

        function updateScoreDisplay(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            const homeScoreElement = document.getElementById('homeScore');
            const awayScoreElement = document.getElementById('awayScore');
            
            if (homeScoreElement) {
                homeScoreElement.textContent = `${homeTeam.name}: ${match.homeScore || 0}`;
            }
            if (awayScoreElement) {
                awayScoreElement.textContent = `${awayTeam.name}: ${match.awayScore || 0}`;
            }
        }

        function updateMVP(matchId, team, playerId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            if (team === 'home') {
                match.homeMVP = parseInt(playerId);
            } else {
                match.awayMVP = parseInt(playerId);
            }
            saveData();
        }

        function calculateMatchScore(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            if (!homeTeam || !awayTeam) return;
            
            let homeScore = 0;
            let awayScore = 0;

            homeTeam.players.forEach(player => {
                if (match.playerStats && match.playerStats[player.id]) {
                    homeScore += match.playerStats[player.id].goals || 0;
                }
            });

            awayTeam.players.forEach(player => {
                if (match.playerStats && match.playerStats[player.id]) {
                    awayScore += match.playerStats[player.id].goals || 0;
                }
            });

            match.homeScore = homeScore;
            match.awayScore = awayScore;
        }

        function saveMatchProgress(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            saveData();
            alert('‚úÖ Progresso della partita salvato!');
        }

        function completeMatch(matchId) {
            if (!confirm('Sei sicuro di voler terminare questa partita?')) return;
            
            const match = matches.find(m => m.id === matchId);
            if (!match) {
                alert('Errore: partita non trovata');
                return;
            }
            
            match.status = 'completed';
            match.completedAt = new Date().toISOString();
            
            updateTeamStats(match);
            updatePlayerStats(match);
            
            saveData();
            
            showMatchCompletedOptions(match);
        }

        function showMatchCompletedOptions(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            if (!homeTeam || !awayTeam) {
                alert('Errore: squadre non trovate');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>‚úÖ Partita Completata!</h3>
                    <p><strong>${homeTeam.name} ${match.homeScore || 0} - ${match.awayScore || 0} ${awayTeam.name}</strong></p>
                    <p>Campo: ${match.field}</p>
                    
                    <div style="margin: 20px 0;">
                        <h4>Invia i risultati all'organizzatore:</h4>
                        <div style="display: grid; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-success" onclick="sendMatchByWhatsApp(${match.id})" style="background: #25D366;">
                                üì± Invia via WhatsApp
                            </button>
                            <button class="btn btn-warning" onclick="copyMatchData(${match.id})">
                                üìã Copia Dati negli Appunti
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="closeMatchCompletedModal()">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function sendMatchByWhatsApp(matchId) {
            const report = generateMatchReport(matchId);
            const encodedReport = encodeURIComponent(report);
            
            const organizerPhone = prompt('Inserisci numero WhatsApp organizzatore (con prefisso, es: +393401234567):', '+39');
            if (!organizerPhone || organizerPhone === '+39') return;
            
            const cleanPhone = organizerPhone.replace(/[^0-9]/g, '');
            const whatsappLink = `https://wa.me/${cleanPhone}?text=${encodedReport}`;
            
            try {
                window.open(whatsappLink, '_blank');
                alert('‚úÖ WhatsApp aperto! Se non funziona, usa "Copia Dati negli Appunti".');
                closeMatchCompletedModal();
            } catch (error) {
                alert('Errore WhatsApp: ' + error.message);
                copyMatchData(matchId);
            }
        }

        function copyMatchData(matchId) {
            const report = generateMatchReport(matchId);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => {
                    alert('‚úÖ Dati della partita copiati negli appunti! Ora puoi incollarli dove preferisci.');
                    closeMatchCompletedModal();
                }).catch(() => {
                    fallbackCopyTextToClipboard(report);
                });
            } else {
                fallbackCopyTextToClipboard(report);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Dati della partita copiati negli appunti!');
                closeMatchCompletedModal();
            } catch (err) {
                alert('‚ùå Impossibile copiare automaticamente. Seleziona e copia manualmente il testo che apparir√†.');
                prompt('Copia questo testo:', text);
            }
            
            document.body.removeChild(textArea);
        }

        function generateMatchReport(matchId) {
            const match = matches.find(m => m.id === matchId);
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);
            
            let report = `üèÜ REPORT PARTITA PALLASCOUT üèÜ\n\n`;
            report += `üìÖ Data: ${new Date(match.completedAt || new Date()).toLocaleString('it-IT')}\n`;
            report += `üèüÔ∏è Campo: ${match.field}\n`;
            report += `üìä Risultato: ${homeTeam.name} ${match.homeScore || 0} - ${match.awayScore || 0} ${awayTeam.name}\n\n`;
            
            // Statistiche squadra casa
            report += `üè† ${homeTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            homeTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.homeMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            // Statistiche squadra ospite  
            report += `\nüöå ${awayTeam.name.toUpperCase()}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            awayTeam.players.forEach(player => {
                const stats = match.playerStats ? match.playerStats[player.id] : null;
                if (stats && (stats.goals > 0 || stats.scalps > 0)) {
                    report += `#${player.number} ${player.name}: ${stats.goals || 0} gol, ${stats.scalps || 0} scalpi`;
                    if (match.awayMVP === player.id) report += ` ‚≠ê MVP`;
                    report += `\n`;
                }
            });
            
            report += `\nüìã ARBITRO: ${getArbitratorName() || 'N/D'}\n`;
            report += `\nüî¢ ID PARTITA: ${match.id}\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            report += `Generato da: Torneo Pallascout App`;
            
            return report;
        }

        function closeMatchCompletedModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            updateRefereeMatchSelect();
            document.getElementById('refereePanel').innerHTML = '';
        }

        function updateTeamStats(match) {
            const homeTeam = teams.find(t => t.id === match.homeTeamId);
            const awayTeam = teams.find(t => t.id === match.awayTeamId);

            if (!homeTeam || !awayTeam) return;
            if (match.statsUpdated) return;

            homeTeam.stats.matches++;
            homeTeam.stats.goalsFor += match.homeScore || 0;
            homeTeam.stats.goalsAgainst += match.awayScore || 0;

            awayTeam.stats.matches++;
            awayTeam.stats.goalsFor += match.awayScore || 0;
            awayTeam.stats.goalsAgainst += match.homeScore || 0;

            if ((match.homeScore || 0) > (match.awayScore || 0)) {
                homeTeam.stats.wins++;
                homeTeam.stats.points += 3;
                awayTeam.stats.losses++;
            } else if ((match.homeScore || 0) < (match.awayScore || 0)) {
                awayTeam.stats.wins++;
                awayTeam.stats.points += 3;
                homeTeam.stats.losses++;
            } else {
                homeTeam.stats.draws++;
                awayTeam.stats.draws++;
                homeTeam.stats.points += 1;
                awayTeam.stats.points += 1;
            }

            if (match.playerStats) {
                homeTeam.players.forEach(player => {
                    if (match.playerStats[player.id]) {
                        homeTeam.stats.scalpFor += match.playerStats[player.id].scalps || 0;
                    }
                });

                awayTeam.players.forEach(player => {
                    if (match.playerStats[player.id]) {
                        awayTeam.stats.scalpFor += match.playerStats[player.id].scalps || 0;
                    }
                });
            }

            match.statsUpdated = true;
        }

        function updatePlayerStats(match) {
            if (match.playerStatsUpdated) return;

            if (match.playerStats) {
                Object.keys(match.playerStats).forEach(playerId => {
                    const playerIdInt = parseInt(playerId);
                    let player = null;
                    
                    teams.forEach(team => {
                        const foundPlayer = team.players.find(p => p.id === playerIdInt);
                        if (foundPlayer) player = foundPlayer;
                    });
                    
                    if (player && match.playerStats[playerId]) {
                        player.stats.goals += match.playerStats[playerId].goals || 0;
                        player.stats.scalps += match.playerStats[playerId].scalps || 0;
                    }
                });
            }

            if (match.homeMVP) {
                teams.forEach(team => {
                    const player = team.players.find(p => p.id === match.homeMVP);
                    if (player) player.stats.mvp++;
                });
            }
            
            if (match.awayMVP) {
                teams.forEach(team => {
                    const player = team.players.find(p => p.id === match.awayMVP);
                    if (player) player.stats.mvp++;
                });
            }

            match.playerStatsUpdated = true;
        }

        function displayStandings() {
            const standingsTable = document.getElementById('standingsTable');
            
            const sortedTeams = [...teams].sort((a, b) => {
                if (b.stats.points !== a.stats.points) {
                    return b.stats.points - a.stats.points;
                }
                const diffA = a.stats.goalsFor - a.stats.goalsAgainst;
                const diffB = b.stats.goalsFor - b.stats.goalsAgainst;
                return diffB - diffA;
            });

            let tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Squadra</th>
                            <th>G</th>
                            <th>V</th>
                            <th>P</th>
                            <th>S</th>
                            <th>GF</th>
                            <th>GS</th>
                            <th>DR</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedTeams.forEach((team, index) => {
                const goalDiff = team.stats.goalsFor - team.stats.goalsAgainst;
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${team.name}</strong></td>
                        <td>${team.stats.matches}</td>
                        <td>${team.stats.wins}</td>
                        <td>${team.stats.draws}</td>
                        <td>${team.stats.losses}</td>
                        <td>${team.stats.goalsFor}</td>
                        <td>${team.stats.goalsAgainst}</td>
                        <td>${goalDiff > 0 ? '+' : ''}${goalDiff}</td>
                        <td><strong>${team.stats.points}</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            standingsTable.innerHTML = tableHTML;
        }

        function displayStats() {
            const statsContent = document.getElementById('statsContent');
            
            const allPlayers = [];
            teams.forEach(team => {
                team.players.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name
                    });
                });
            });

            const topScorers = [...allPlayers]
                .filter(p => p.stats.goals > 0)
                .sort((a, b) => b.stats.goals - a.stats.goals)
                .slice(0, 10);

            const topScalpers = [...allPlayers]
                .filter(p => p.stats.scalps > 0)
                .sort((a, b) => b.stats.scalps - a.stats.scalps)
                .slice(0, 10);

            const topMVPs = [...allPlayers]
                .filter(p => p.stats.mvp > 0)
                .sort((a, b) => b.stats.mvp - a.stats.mvp)
                .slice(0, 10);

            let statsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3>ü•Ö Migliori Marcatori</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>Gol</th></tr>
                            </thead>
                            <tbody>
                                ${topScorers.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.goals}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>‚öîÔ∏è Migliori Scalpers</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>Scalpi</th></tr>
                            </thead>
                            <tbody>
                                ${topScalpers.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.scalps}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>üèÜ Pi√π MVP</h3>
                        <table class="table">
                            <thead>
                                <tr><th>Giocatore</th><th>Squadra</th><th>MVP</th></tr>
                            </thead>
                            <tbody>
                                ${topMVPs.map((player, i) => `
                                    <tr>
                                        <td>#${player.number} ${player.name}</td>
                                        <td>${player.teamName}</td>
                                        <td><strong>${player.stats.mvp}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>üìä Statistiche Generali</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div>
                            <h4>${teams.length}</h4>
                            <p>Squadre Registrate</p>
                        </div>
                        <div>
                            <h4>${allPlayers.length}</h4>
                            <p>Giocatori Registrati</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'completed').length}</h4>
                            <p>Partite Completate</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'in_progress').length}</h4>
                            <p>Partite in Corso</p>
                        </div>
                        <div>
                            <h4>${matches.filter(m => m.status === 'scheduled').length}</h4>
                            <p>Partite Programmate</p>
                        </div>
                        <div>
                            <h4>${allPlayers.reduce((sum, p) => sum + p.stats.goals, 0)}</h4>
                            <p>Gol Totali</p>
                        </div>
                        <div>
                            <h4>${allPlayers.reduce((sum, p) => sum + p.stats.scalps, 0)}</h4>
                            <p>Scalpi Totali</p>
                        </div>
                    </div>
                </div>
            `;

            statsContent.innerHTML = statsHTML;
        }

        function getArbitratorName() {
            return localStorage.getItem('arbitrator_name') || null;
        }

        function setArbitratorName() {
            const name = prompt('Inserisci il tuo nome (arbitro):', getArbitratorName() || '');
            if (name) {
                localStorage.setItem('arbitrator_name', name);
                alert(`Nome arbitro salvato: ${name}`);
                updateArbitratorDisplay();
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            displayTeams();
        });
    </script>
</body>
</html>