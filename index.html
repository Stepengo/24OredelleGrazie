<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Torneo Pallascout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #4ECDC4;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #fd79a8, #e84393);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .team-setup {
            display: none;
        }

        .match-form {
            display: none;
        }

        .player-stats {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .player-stats input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
        }

        .match-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }

        .team-name {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        .vs {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f4;
            border-top: 4px solid #4ECDC4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 20px 0;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
            display: none;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .mvp-selection {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .mvp-selection h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .match-header {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .vs {
                order: -1;
            }
            
            .player-stats {
                grid-template-columns: 1fr;
                gap: 5px;
                text-align: center;
            }
        }

        .import-section {
            background: #e8f5e8;
            border-left-color: #28a745;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .teams-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .team-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .team-item h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .player-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Gestione Torneo Pallascout</h1>
            <p>Sistema di gestione completo per tornei sportivi con sincronizzazione Google Sheets</p>
        </div>

        <div class="main-content">
            <div class="navigation">
                <button class="tab active" onclick="showSection('import')">üì• Importa Squadre</button>
                <button class="tab" onclick="showSection('match')">‚öΩ Gestisci Partita</button>
                <button class="tab" onclick="showSection('results')">üìä Risultati</button>
                <button class="tab" onclick="showSection('settings')">‚öôÔ∏è Impostazioni</button>
            </div>

            <!-- Sezione Importazione Squadre -->
            <div id="import-section" class="section import-section">
                <h2>üì• Importazione Squadre</h2>
                <p style="margin-bottom: 20px; color: #666;">
                    Importa le squadre dal Google Sheets generato dal form di iscrizione. 
                    Il file deve contenere: Nome Squadra, Nome Giocatore, Numero Maglia.
                </p>
                
                <div class="form-group">
                    <label>Carica file CSV dal Google Sheets:</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
                        üìé Seleziona file CSV
                    </div>
                </div>

                <div class="form-group">
                    <label for="sheetsUrl">URL Google Sheets (opzionale - per sincronizzazione automatica):</label>
                    <input type="url" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>

                <div class="form-group">
                    <button class="btn btn-secondary" onclick="connectGoogleSheets()">üîó Connetti Google Sheets</button>
                    <button class="btn" onclick="importTeamsFromFile()">üì§ Importa Squadre</button>
                </div>

                <div id="teams-preview" class="teams-preview" style="display: none;">
                    <h3>Anteprima Squadre Importate:</h3>
                    <div id="teams-list"></div>
                </div>
            </div>

            <!-- Sezione Gestione Partita -->
            <div id="match-section" class="section" style="display: none;">
                <h2>‚öΩ Gestione Partita</h2>
                
                <div class="form-group">
                    <label for="matchId">ID Partita:</label>
                    <input type="text" id="matchId" placeholder="es. Gruppo1-Partita3">
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label for="team1Select">Squadra 1:</label>
                        <select id="team1Select" onchange="loadTeamPlayers('team1')">
                            <option value="">Seleziona squadra...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="team2Select">Squadra 2:</label>
                        <select id="team2Select" onchange="loadTeamPlayers('team2')">
                            <option value="">Seleziona squadra...</option>
                        </select>
                    </div>
                </div>

                <button class="btn" onclick="startMatch()">üöÄ Inizia Partita</button>

                <div id="match-form" class="match-form">
                    <div class="match-header">
                        <div class="team-name" id="team1Name">Squadra 1</div>
                        <div class="vs">VS</div>
                        <div class="team-name" id="team2Name">Squadra 2</div>
                    </div>

                    <div class="grid">
                        <!-- Squadra 1 -->
                        <div class="card">
                            <h3 id="team1Title">Squadra 1</h3>
                            <div class="player-stats" style="background: #4ECDC4; color: white; font-weight: bold;">
                                <div>Giocatore</div>
                                <div>Gol</div>
                                <div>Scalpi</div>
                                <div>MVP</div>
                            </div>
                            <div id="team1Players"></div>
                            
                            <div class="mvp-selection">
                                <h4>üèÖ MVP Squadra 1:</h4>
                                <select id="mvp1Select">
                                    <option value="">Seleziona MVP...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Squadra 2 -->
                        <div class="card">
                            <h3 id="team2Title">Squadra 2</h3>
                            <div class="player-stats" style="background: #FF6B6B; color: white; font-weight: bold;">
                                <div>Giocatore</div>
                                <div>Gol</div>
                                <div>Scalpi</div>
                                <div>MVP</div>
                            </div>
                            <div id="team2Players"></div>
                            
                            <div class="mvp-selection">
                                <h4>üèÖ MVP Squadra 2:</h4>
                                <select id="mvp2Select">
                                    <option value="">Seleziona MVP...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="stats-summary">
                        <div class="stat-card">
                            <span class="stat-value" id="team1Score">0</span>
                            <span>Gol Squadra 1</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="team2Score">0</span>
                            <span>Gol Squadra 2</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="totalScalps">0</span>
                            <span>Scalpi Totali</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="saveMatchResult()">üíæ Salva Risultato</button>
                        <button class="btn btn-secondary" onclick="resetMatch()">üîÑ Reset Partita</button>
                    </div>
                </div>
            </div>

           <!-- Sezione Risultati -->
            <div id="results-section" class="section" style="display: none;">
                <h2>üìä Risultati e Classifiche</h2>
                
                <div class="grid">
                    <div class="card">
                        <h3>üèÜ Classifica Generale</h3>
                        <div id="standings-table">
                            <div class="player-stats" style="background: #667eea; color: white; font-weight: bold;">
                                <div>Pos</div>
                                <div>Squadra</div>
                                <div>Punti</div>
                                <div>Gol</div>
                            </div>
                            <div id="standings-list"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>‚öΩ Top Marcatori</h3>
                        <div id="scorers-table">
                            <div class="player-stats" style="background: #FF6B6B; color: white; font-weight: bold;">
                                <div>Pos</div>
                                <div>Giocatore</div>
                                <div>Squadra</div>
                                <div>Gol</div>
                            </div>
                            <div id="scorers-list"></div>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <h3>üó°Ô∏è Classifica Scalpi</h3>
                        <div id="scalps-table">
                            <div class="player-stats" style="background: #4ECDC4; color: white; font-weight: bold;">
                                <div>Pos</div>
                                <div>Giocatore</div>
                                <div>Squadra</div>
                                <div>Scalpi</div>
                            </div>
                            <div id="scalps-list"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üèÖ Hall of Fame MVP</h3>
                        <div id="mvp-table">
                            <div class="player-stats" style="background: #764ba2; color: white; font-weight: bold;">
                                <div>Giocatore</div>
                                <div>Squadra</div>
                                <div>MVP Count</div>
                                <div>Partite</div>
                            </div>
                            <div id="mvp-list"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn" onclick="exportResults()">üì§ Esporta Risultati</button>
                    <button class="btn btn-secondary" onclick="refreshResults()">üîÑ Aggiorna</button>
                </div>
            </div>

            <!-- Sezione Impostazioni -->
            <div id="settings-section" class="section" style="display: none;">
                <h2>‚öôÔ∏è Impostazioni</h2>
                
                <div class="card">
                    <h3>üîó Configurazione Google Sheets</h3>
                    
                    <div class="form-group">
                        <label for="apiKey">API Key Google Sheets:</label>
                        <input type="password" id="apiKey" placeholder="Inserisci la tua API key">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Necessaria per la sincronizzazione automatica con Google Sheets
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="spreadsheetId">ID Spreadsheet:</label>
                        <input type="text" id="spreadsheetId" placeholder="ID del foglio Google Sheets">
                    </div>
                    
                    <div class="form-group">
                        <label for="teamsRange">Range celle squadre:</label>
                        <input type="text" id="teamsRange" value="Squadre!A:C" placeholder="es. Squadre!A:C">
                    </div>
                    
                    <div class="form-group">
                        <label for="resultsRange">Range celle risultati:</label>
                        <input type="text" id="resultsRange" value="Risultati!A:Z" placeholder="es. Risultati!A:Z">
                    </div>
                    
                    <button class="btn" onclick="testConnection()">üîç Testa Connessione</button>
                    <button class="btn btn-secondary" onclick="saveSettings()">üíæ Salva Impostazioni</button>
                </div>
                
                <div class="card">
                    <h3>üéÆ Regole del Gioco</h3>
                    
                    <div class="form-group">
                        <label for="winPoints">Punti per vittoria:</label>
                        <input type="number" id="winPoints" value="3" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="drawPoints">Punti per pareggio:</label>
                        <input type="number" id="drawPoints" value="1" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="lossPoints">Punti per sconfitta:</label>
                        <input type="number" id="lossPoints" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableScalps" checked> Abilita conteggio scalpi
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableMVP" checked> Abilita selezione MVP
                        </label>
                    </div>
                    
                    <button class="btn" onclick="saveGameSettings()">üíæ Salva Regole</button>
                </div>
                
                <div class="card">
                    <h3>üóÇÔ∏è Gestione Dati</h3>
                    
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="exportData()">üì§ Esporta Tutti i Dati</button>
                        <button class="btn btn-secondary" onclick="importData()">üì• Importa Dati</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Cancella Tutti i Dati</button>
                        <small style="color: #dc3545; display: block; margin-top: 5px;">
                            ‚ö†Ô∏è Attenzione: questa operazione canceller√† tutti i dati salvati
                        </small>
                    </div>
                </div>
            </div>

            <!-- Messaggi di stato -->
            <div id="success-message" class="success-message">
                <strong>‚úÖ Successo!</strong> <span id="success-text"></span>
            </div>
            
            <div id="error-message" class="error-message">
                <strong>‚ùå Errore!</strong> <span id="error-text"></span>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Caricamento in corso...</p>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali per gestire i dati
        let teams = [];
        let currentMatch = null;
        let matchResults = [];
        let settings = {
            apiKey: '',
            spreadsheetId: '',
            teamsRange: 'Squadre!A:C',
            resultsRange: 'Risultati!A:Z',
            winPoints: 3,
            drawPoints: 1,
            lossPoints: 0,
            enableScalps: true,
            enableMVP: true
        };

        // Inizializzazione dell'applicazione
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadTeams();
            loadMatchResults();
            updateTeamSelects();
            updateResults();
            console.log('üèÜ Pallascout Tournament Manager caricato!');
        });

        // Gestione delle sezioni/tab
        function showSection(sectionName) {
            // Nasconde tutte le sezioni
            const sections = ['import-section', 'match-section', 'results-section', 'settings-section'];
            sections.forEach(section => {
                document.getElementById(section).style.display = 'none';
            });
            
            // Rimuove classe active da tutti i tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra la sezione selezionata
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Attiva il tab corrispondente
            event.target.classList.add('active');
        }

        // Gestione caricamento file CSV
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const parsedTeams = parseCSV(csv);
                    displayTeamsPreview(parsedTeams);
                    showLoading(false);
                    showSuccess('File CSV caricato con successo! Clicca "Importa Squadre" per confermare.');
                } catch (error) {
                    showLoading(false);
                    showError('Errore nel caricamento del file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Parser CSV
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            
            // Trova gli indici delle colonne necessarie
            const teamNameIndex = headers.findIndex(h => 
                h.includes('squadra') || h.includes('team') || h.includes('nome squadra')
            );
            const playerNameIndex = headers.findIndex(h => 
                h.includes('giocatore') || h.includes('player') || h.includes('nome giocatore')
            );
            const jerseyNumberIndex = headers.findIndex(h => 
                h.includes('maglia') || h.includes('numero') || h.includes('jersey')
            );

            if (teamNameIndex === -1 || playerNameIndex === -1 || jerseyNumberIndex === -1) {
                throw new Error('Colonne necessarie non trovate. Assicurati che il CSV contenga: Nome Squadra, Nome Giocatore, Numero Maglia');
            }

            const teamsMap = new Map();
            
            // Processa ogni riga (salta la prima con gli headers)
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(col => col.trim().replace(/"/g, ''));
                
                if (cols.length >= 3) {
                    const teamName = cols[teamNameIndex];
                    const playerName = cols[playerNameIndex];
                    const jerseyNumber = parseInt(cols[jerseyNumberIndex]);

                    if (teamName && playerName && !isNaN(jerseyNumber)) {
                        if (!teamsMap.has(teamName)) {
                            teamsMap.set(teamName, {
                                name: teamName,
                                players: []
                            });
                        }

                        teamsMap.get(teamName).players.push({
                            name: playerName,
                            jerseyNumber: jerseyNumber,
                            goals: 0,
                            scalps: 0,
                            mvpCount: 0
                        });
                    }
                }
            }

            return Array.from(teamsMap.values());
        }

        // Visualizza anteprima squadre
        function displayTeamsPreview(parsedTeams) {
            const preview = document.getElementById('teams-preview');
            const teamsList = document.getElementById('teams-list');
            
            teamsList.innerHTML = '';
            
            parsedTeams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-item';
                
                const playersHtml = team.players
                    .sort((a, b) => a.jerseyNumber - b.jerseyNumber)
                    .map(player => `
                        <div class="player-item">
                            #${player.jerseyNumber} ${player.name}
                        </div>
                    `).join('');
                
                teamDiv.innerHTML = `
                    <h4>${team.name} (${team.players.length} giocatori)</h4>
                    <div class="players-list">
                        ${playersHtml}
                    </div>
                `;
                
                teamsList.appendChild(teamDiv);
            });
            
            preview.style.display = 'block';
            window.parsedTeamsData = parsedTeams; // Salva per l'importazione
        }

        // Importa squadre dal file
        function importTeamsFromFile() {
            if (!window.parsedTeamsData) {
                showError('Prima carica un file CSV!');
                return;
            }

            teams = window.parsedTeamsData;
            saveTeams();
            updateTeamSelects();
            showSuccess(`Importate ${teams.length} squadre con successo!`);
            
            // Nasconde l'anteprima
            document.getElementById('teams-preview').style.display = 'none';
            window.parsedTeamsData = null;
        }
        // Connessione a Google Sheets
        async function connectGoogleSheets() {
            const sheetsUrl = document.getElementById('sheetsUrl').value;
            if (!sheetsUrl) {
                showError('Inserisci l\'URL di Google Sheets!');
                return;
            }

            showLoading(true);
            
            try {
                // Estrae l'ID del foglio dall'URL
                const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (match) {
                    const spreadsheetId = match[1];
                    document.getElementById('spreadsheetId').value = spreadsheetId;
                    settings.spreadsheetId = spreadsheetId;
                    saveSettings();
                    
                    showLoading(false);
                    showSuccess('Google Sheets collegato! Configura l\'API Key nelle impostazioni per la sincronizzazione automatica.');
                } else {
                    throw new Error('URL non valido');
                }
            } catch (error) {
                showLoading(false);
                showError('Errore nella connessione: ' + error.message);
            }
        }

        // Aggiorna le select delle squadre
        function updateTeamSelects() {
            const team1Select = document.getElementById('team1Select');
            const team2Select = document.getElementById('team2Select');
            
            team1Select.innerHTML = '<option value="">Seleziona squadra...</option>';
            team2Select.innerHTML = '<option value="">Seleziona squadra...</option>';
            
            teams.forEach((team, index) => {
                const option1 = document.createElement('option');
                option1.value = index;
                option1.textContent = team.name;
                team1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = index;
                option2.textContent = team.name;
                team2Select.appendChild(option2);
            });
        }

        // Carica giocatori di una squadra
        function loadTeamPlayers(teamNumber) {
            const selectElement = document.getElementById(`team${teamNumber}Select`);
            const teamIndex = parseInt(selectElement.value);
            
            if (isNaN(teamIndex)) return;
            
            const team = teams[teamIndex];
            const mvpSelect = document.getElementById(`mvp${teamNumber}Select`);
            
            mvpSelect.innerHTML = '<option value="">Seleziona MVP...</option>';
            team.players.forEach((player, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `#${player.jerseyNumber} ${player.name}`;
                mvpSelect.appendChild(option);
            });
        }

        // Inizia una partita
        function startMatch() {
            const matchId = document.getElementById('matchId').value;
            const team1Index = parseInt(document.getElementById('team1Select').value);
            const team2Index = parseInt(document.getElementById('team2Select').value);

            if (!matchId) {
                showError('Inserisci un ID per la partita!');
                return;
            }

            if (isNaN(team1Index) || isNaN(team2Index)) {
                showError('Seleziona entrambe le squadre!');
                return;
            }

            if (team1Index === team2Index) {
                showError('Non puoi selezionare la stessa squadra due volte!');
                return;
            }

            currentMatch = {
                id: matchId,
                team1Index: team1Index,
                team2Index: team2Index,
                team1: JSON.parse(JSON.stringify(teams[team1Index])), // Deep copy
                team2: JSON.parse(JSON.stringify(teams[team2Index]))  // Deep copy
            };

            setupMatchForm();
            document.getElementById('match-form').style.display = 'block';
            showSuccess('Partita iniziata! Inserisci le statistiche dei giocatori.');
        }

        // Configura il form della partita
        function setupMatchForm() {
            document.getElementById('team1Name').textContent = currentMatch.team1.name;
            document.getElementById('team2Name').textContent = currentMatch.team2.name;
            document.getElementById('team1Title').textContent = currentMatch.team1.name;
            document.getElementById('team2Title').textContent = currentMatch.team2.name;

            setupTeamPlayersForm('team1', currentMatch.team1);
            setupTeamPlayersForm('team2', currentMatch.team2);
            
            updateMatchStats();
        }

        // Configura i giocatori di una squadra nel form
        function setupTeamPlayersForm(teamId, team) {
            const container = document.getElementById(`${teamId}Players`);
            container.innerHTML = '';

            team.players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-stats';
                playerDiv.innerHTML = `
                    <div>#${player.jerseyNumber} ${player.name}</div>
                    <div>
                        <input type="number" 
                               id="${teamId}_goals_${index}" 
                               min="0" 
                               value="0" 
                               onchange="updateMatchStats()">
                    </div>
                    <div>
                        <input type="number" 
                               id="${teamId}_scalps_${index}" 
                               min="0" 
                               value="0" 
                               onchange="updateMatchStats()"
                               ${settings.enableScalps ? '' : 'disabled'}>
                    </div>
                    <div>
                        <input type="radio" 
                               name="${teamId}_mvp" 
                               value="${index}"
                               ${settings.enableMVP ? '' : 'disabled'}>
                    </div>
                `;
                container.appendChild(playerDiv);
            });
        }

        // Aggiorna le statistiche della partita
        function updateMatchStats() {
            if (!currentMatch) return;

            let team1Goals = 0;
            let team2Goals = 0;
            let totalScalps = 0;

            // Calcola gol squadra 1
            currentMatch.team1.players.forEach((player, index) => {
                const goalsInput = document.getElementById(`team1_goals_${index}`);
                const scalpsInput = document.getElementById(`team1_scalps_${index}`);
                
                if (goalsInput) {
                    const goals = parseInt(goalsInput.value) || 0;
                    team1Goals += goals;
                }
                
                if (scalpsInput) {
                    const scalps = parseInt(scalpsInput.value) || 0;
                    totalScalps += scalps;
                }
            });

            // Calcola gol squadra 2
            currentMatch.team2.players.forEach((player, index) => {
                const goalsInput = document.getElementById(`team2_goals_${index}`);
                const scalpsInput = document.getElementById(`team2_scalps_${index}`);
                
                if (goalsInput) {
                    const goals = parseInt(goalsInput.value) || 0;
                    team2Goals += goals;
                }
                
                if (scalpsInput) {
                    const scalps = parseInt(scalpsInput.value) || 0;
                    totalScalps += scalps;
                }
            });

            // Aggiorna i contatori visivi
            document.getElementById('team1Score').textContent = team1Goals;
            document.getElementById('team2Score').textContent = team2Goals;
            document.getElementById('totalScalps').textContent = totalScalps;
        }

        // Salva il risultato della partita
        function saveMatchResult() {
            if (!currentMatch) {
                showError('Nessuna partita in corso!');
                return;
            }

            showLoading(true);

            // Raccoglie i dati della partita
            const matchResult = {
                id: currentMatch.id,
                timestamp: new Date().toISOString(),
                team1: {
                    name: currentMatch.team1.name,
                    players: [],
                    totalGoals: 0,
                    mvp: null
                },
                team2: {
                    name: currentMatch.team2.name,
                    players: [],
                    totalGoals: 0,
                    mvp: null
                }
            };

            // Processa giocatori squadra 1
            currentMatch.team1.players.forEach((player, index) => {
                const goals = parseInt(document.getElementById(`team1_goals_${index}`).value) || 0;
                const scalps = parseInt(document.getElementById(`team1_scalps_${index}`).value) || 0;
                
                matchResult.team1.players.push({
                    name: player.name,
                    jerseyNumber: player.jerseyNumber,
                    goals: goals,
                    scalps: scalps
                });
                
                matchResult.team1.totalGoals += goals;
            });

            // Processa giocatori squadra 2
            currentMatch.team2.players.forEach((player, index) => {
                const goals = parseInt(document.getElementById(`team2_goals_${index}`).value) || 0;
                const scalps = parseInt(document.getElementById(`team2_scalps_${index}`).value) || 0;
                
                matchResult.team2.players.push({
                    name: player.name,
                    jerseyNumber: player.jerseyNumber,
                    goals: goals,
                    scalps: scalps
                });
                
                matchResult.team2.totalGoals += goals;
            });

            // Trova MVP
            const mvp1Radio = document.querySelector('input[name="team1_mvp"]:checked');
            const mvp2Radio = document.querySelector('input[name="team2_mvp"]:checked');
            
            if (mvp1Radio) {
                const playerIndex = parseInt(mvp1Radio.value);
                matchResult.team1.mvp = matchResult.team1.players[playerIndex];
            }
            
            if (mvp2Radio) {
                const playerIndex = parseInt(mvp2Radio.value);
                matchResult.team2.mvp = matchResult.team2.players[playerIndex];
            }

            // Calcola punti
            if (matchResult.team1.totalGoals > matchResult.team2.totalGoals) {
                matchResult.team1.points = settings.winPoints;
                matchResult.team2.points = settings.lossPoints;
            } else if (matchResult.team1.totalGoals < matchResult.team2.totalGoals) {
                matchResult.team1.points = settings.lossPoints;
                matchResult.team2.points = settings.winPoints;
            } else {
                matchResult.team1.points = settings.drawPoints;
                matchResult.team2.points = settings.drawPoints;
            }

            // Salva il risultato
            matchResults.push(matchResult);
            saveMatchResults();
            updatePlayerStats(matchResult);
            
            // Sincronizza con Google Sheets se configurato
            syncWithGoogleSheets(matchResult);

            showLoading(false);
            showSuccess(`Partita "${currentMatch.id}" salvata con successo!`);
            
            // Reset della partita
            resetMatch();
            updateResults();
        }

        // Aggiorna le statistiche dei giocatori
        function updatePlayerStats(matchResult) {
            // Aggiorna statistiche squadra 1
            const team1 = teams[currentMatch.team1Index];
            matchResult.team1.players.forEach(matchPlayer => {
                const player = team1.players.find(p => 
                    p.name === matchPlayer.name && p.jerseyNumber === matchPlayer.jerseyNumber
                );
                if (player) {
                    player.goals += matchPlayer.goals;
                    player.scalps += matchPlayer.scalps;
                    if (matchResult.team1.mvp && matchResult.team1.mvp.name === player.name) {
                        player.mvpCount++;
                    }
                }
            });

            // Aggiorna statistiche squadra 2
            const team2 = teams[currentMatch.team2Index];
            matchResult.team2.players.forEach(matchPlayer => {
                const player = team2.players.find(p => 
                    p.name === matchPlayer.name && p.jerseyNumber === matchPlayer.jerseyNumber
                );
                if (player) {
                    player.goals += matchPlayer.goals;
                    player.scalps += matchPlayer.scalps;
                    if (matchResult.team2.mvp && matchResult.team2.mvp.name === player.name) {
                        player.mvpCount++;
                    }
                }
            });

            saveTeams();
        }

        // Reset partita
        function resetMatch() {
            currentMatch = null;
            document.getElementById('match-form').style.display = 'none';
            document.getElementById('matchId').value = '';
            document.getElementById('team1Select').value = '';
            document.getElementById('team2Select').value = '';
        }

        // Sincronizzazione con Google Sheets
        async function syncWithGoogleSheets(matchResult) {
            if (!settings.apiKey || !settings.spreadsheetId) {
                console.log('Sincronizzazione Google Sheets non configurata');
                return;
            }

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${settings.spreadsheetId}/values/${settings.resultsRange}:append?valueInputOption=RAW&key=${settings.apiKey}`;
                
                const values = [[
                    matchResult.timestamp,
                    matchResult.id,
                    matchResult.team1.name,
                    matchResult.team1.totalGoals,
                    matchResult.team1.points,
                    matchResult.team1.mvp ? matchResult.team1.mvp.name : '',
                    matchResult.team2.name,
                    matchResult.team2.totalGoals,
                    matchResult.team2.points,
                    matchResult.team2.mvp ? matchResult.team2.mvp.name : ''
                ]];

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ values: values })
                });

                if (!response.ok) {
                    throw new Error('Errore nella sincronizzazione');
                }

                console.log('Dati sincronizzati con Google Sheets');
            } catch (error) {
                console.error('Errore sincronizzazione Google Sheets:', error);
            }
        }

        // Aggiorna risultati e classifiche
        function updateResults() {
            updateStandings();
            updateTopScorers();
            updateScalpsRanking();
            updateMVPRanking();
        }

        // Calcola e mostra classifica
        function updateStandings() {
            const standings = {};
            
            // Inizializza le squadre
            teams.forEach(team => {
                standings[team.name] = {
                    name: team.name,
                    points: 0,
                    goals: 0,
                    matches: 0
                };
            });

            // Calcola statistiche da tutti i risultati
            matchResults.forEach(match => {
                if (standings[match.team1.name]) {
                    standings[match.team1.name].points += match.team1.points;
                    standings[match.team1.name].goals += match.team1.totalGoals;
                    standings[match.team1.name].matches++;
                }
                
                if (standings[match.team2.name]) {
                    standings[match.team2.name].points += match.team2.points;
                    standings[match.team2.name].goals += match.team2.totalGoals;
                    standings[match.team2.name].matches++;
                }
            });

            // Ordina per punti e gol
            const sortedStandings = Object.values(standings)
                .sort((a, b) => b.points - a.points || b.goals - a.goals);

            // Visualizza classifica
            const standingsList = document.getElementById('standings-list');
            standingsList.innerHTML = '';

            sortedStandings.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'player-stats';
                teamDiv.innerHTML = `
                    <div>${index + 1}</div>
                    <div>${team.name}</div>
                    <div>${team.points}</div>
                    <div>${team.goals}</div>
                `;
                standingsList.appendChild(teamDiv);
            });
        }

        // Aggiorna classifica marcatori
        function updateTopScorers() {
            const scorers = [];
            
            teams.forEach(team => {
                team.players.forEach(player => {
                    if (player.goals > 0) {
                        scorers.push({
                            name: player.name,
                            team: team.name,
                            goals: player.goals,
                            jerseyNumber: player.jerseyNumber
                        });
                    }
                });
            });

            scorers.sort((a, b) => b.goals - a.goals);

            const scorersList = document.getElementById('scorers-list');
            scorersList.innerHTML = '';

            scorers.slice(0, 10).forEach((scorer, index) => {
                const scorerDiv = document.createElement('div');
                scorerDiv.className = 'player-stats';
                scorerDiv.innerHTML = `
                    <div>${index + 1}</div>
                    <div>#${scorer.jerseyNumber} ${scorer.name}</div>
                    <div>${scorer.team}</div>
                    <div>${scorer.goals}</div>
                `;
                scorersList.appendChild(scorerDiv);
            });
        }

        // Aggiorna classifica scalpi
        function updateScalpsRanking() {
            const scalpHunters = [];
            
            teams.forEach(team => {
                team.players.forEach(player => {
                    if (player.scalps > 0) {
                        scalpHunters.push({
                            name: player.name,
                            team: team.name,
                            scalps: player.scalps,
                            jerseyNumber: player.jerseyNumber
                        });
                    }
                });
            });

            scalpHunters.sort((a, b) => b.scalps - a.scalps);

            const scalpsList = document.getElementById('scalps-list');
            scalpsList.innerHTML = '';

            scalpHunters.slice(0, 10).forEach((hunter, index) => {
                const hunterDiv = document.createElement('div');
                hunterDiv.className = 'player-stats';
                hunterDiv.innerHTML = `
                    <div>${index + 1}</div>
                    <div>#${hunter.jerseyNumber} ${hunter.name}</div>
                    <div>${hunter.team}</div>
                    <div>${hunter.scalps}</div>
                `;
                scalpsList.appendChild(hunterDiv);
            });
        }

        // Aggiorna classifica MVP
        function updateMVPRanking() {
            const mvps = [];
            
            teams.forEach(team => {
                team.players.forEach(player => {
                    if (player.mvpCount > 0) {
                        mvps.push({
                            name: player.name,
                            team: team.name,
                            mvpCount: player.mvpCount,
                            jerseyNumber: player.jerseyNumber
                        });
                    }
                });
            });

            mvps.sort((a, b) => b.mvpCount - a.mvpCount);

            const mvpList = document.getElementById('mvp-list');
            mvpList.innerHTML = '';

            mvps.slice(0, 10).forEach(mvp => {
                const mvpDiv = document.createElement('div');
                mvpDiv.className = 'player-stats';
                mvpDiv.innerHTML = `
                    <div>#${mvp.jerseyNumber} ${mvp.name}</div>
                    <div>${mvp.team}</div>
                    <div>${mvp.mvpCount}</div>
                    <div>-</div>
                `;
                mvpList.appendChild(mvpDiv);
            });
        }

        // Funzioni di salvataggio e caricamento
        function saveTeams() {
            try {
                const data = JSON.stringify(teams);
                // In un ambiente reale, qui salveresti su un database o localStorage
                console.log('Squadre salvate:', teams.length);
            } catch (error) {
                console.error('Errore salvataggio squadre:', error);
            }
        }

        function loadTeams() {
            try {
                // In un ambiente reale, qui caricheresti da un database o localStorage
                // teams = JSON.parse(localStorage.getItem('pallascout_teams')) || [];
                console.log('Squadre caricate:', teams.length);
            } catch (error) {
                console.error('Errore caricamento squadre:', error);
                teams = [];
            }
        }

        function saveMatchResults() {
            try {
                const data = JSON.stringify(matchResults);
                // In un ambiente reale, qui salveresti su un database o localStorage
                console.log('Risultati salvati:', matchResults.length);
            } catch (error) {
                console.error('Errore salvataggio risultati:', error);
            }
        }

        function loadMatchResults() {
            try {
                // In un ambiente reale, qui caricheresti da un database o localStorage
                // matchResults = JSON.parse(localStorage.getItem('pallascout_results')) || [];
                console.log('Risultati caricati:', matchResults.length);
            } catch (error) {
                console.error('Errore caricamento risultati:', error);
                matchResults = [];
            }
        }

        function saveSettings() {
            try {
                const data = JSON.stringify(settings);
                // In un ambiente reale, qui salveresti su un database o localStorage
                console.log('Impostazioni salvate');
            } catch (error) {
                console.error('Errore salvataggio impostazioni:', error);
            }
        }

        function loadSettings() {
            try {
                // In un ambiente reale, qui caricheresti da un database o localStorage
                // const saved = localStorage.getItem('pallascout_settings');
                // if (saved) settings = {...settings, ...JSON.parse(saved)};
                
                // Aggiorna i campi del form
                document.getElementById('apiKey').value = settings.apiKey;
                document.getElementById('spreadsheetId').value = settings.spreadsheetId;
                document.getElementById('teamsRange').value = settings.teamsRange;
                document.getElementById('resultsRange').value = settings.resultsRange;
                document.getElementById('winPoints').value = settings.winPoints;
                document.getElementById('drawPoints').value = settings.drawPoints;
                document.getElementById('lossPoints').value = settings.lossPoints;
                document.getElementById('enableScalps').checked = settings.enableScalps;
                document.getElementById('enableMVP').checked = settings.enableMVP;
                
                console.log('Impostazioni caricate');
            } catch (error) {
                console.error('Errore caricamento impostazioni:', error);
            }
        }

        // Funzioni delle impostazioni
        function testConnection() {
            if (!settings.apiKey || !settings.spreadsheetId) {
                showError('Configura prima API Key e ID Spreadsheet!');
                return;
            }
            
            showLoading(true);
            
            // Test connection simulato
            setTimeout(() => {
                showLoading(false);
                showSuccess('Connessione testata con successo!');
            }, 2000);
        }

        function saveGameSettings() {
            settings.winPoints = parseInt(document.getElementById('winPoints').value);
            settings.drawPoints = parseInt(document.getElementById('drawPoints').value);
            settings.lossPoints = parseInt(document.getElementById('lossPoints').value);
            settings.enableScalps = document.getElementById('enableScalps').checked;
            settings.enableMVP = document.getElementById('enableMVP').checked;
            
            saveSettings();
            showSuccess('Regole del gioco salvate!');
        }

        // Funzioni utility
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSuccess(message) {
            const element = document.getElementById('success-message');
            document.getElementById('success-text').textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        function showError(message) {
            const element = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        function refreshResults() {
            updateResults();
            showSuccess('Risultati aggiornati!');
        }

        function exportResults() {
            const data = {
                teams: teams,
                matchResults: matchResults,
                settings: settings,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pallascout_risultati_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Risultati esportati con successo!');
        }

        function exportData() {
            exportResults();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.teams) teams = data.teams;
                        if (data.matchResults) matchResults = data.matchResults;
                        if (data.settings) settings = {...settings, ...data.settings};
                        
                        saveTeams();
                        saveMatchResults();
                        saveSettings();
                        loadSettings();
                        updateTeamSelects();
                        updateResults();
                        
                        showSuccess('Dati importati con successo!');
                    } catch (error) {
                        showError('Errore nell\'importazione: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questa operazione canceller√† TUTTI i dati salvati. Sei sicuro?')) {
                teams = [];
                matchResults = [];
                currentMatch = null;
                
                saveTeams();
                saveMatchResults();
                updateTeamSelects();
                updateResults();
                resetMatch();
                
                showSuccess('Tutti i dati sono stati cancellati.');
            }
        }
    </script>
</body>
</html>
